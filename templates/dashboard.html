<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - {{ title }}</title>
    <link rel="stylesheet" href="{{ url_for('static', path='/style.css') }}">
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script>
        // Configure axios to send cookies with all requests
        axios.defaults.withCredentials = true;
    </script>
    <style>
        /* Notification System Styles */
        .notification-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            max-width: 400px;
        }
        
        .notification {
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            margin-bottom: 10px;
            padding: 16px;
            border-left: 4px solid;
            animation: slideIn 0.3s ease-out;
            position: relative;
        }
        
        .notification.error {
            border-left-color: #e74c3c;
            background: linear-gradient(90deg, #fdf2f2 0%, #fff 100%);
        }
        
        .notification.success {
            border-left-color: #27ae60;
            background: linear-gradient(90deg, #f0f9f0 0%, #fff 100%);
        }
        
        .notification.warning {
            border-left-color: #f39c12;
            background: linear-gradient(90deg, #fdf8f0 0%, #fff 100%);
        }
        
        .notification.info {
            border-left-color: #3498db;
            background: linear-gradient(90deg, #f0f8ff 0%, #fff 100%);
        }
        
        .notification-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .notification-title {
            font-weight: bold;
            font-size: 14px;
        }
        
        .notification-close {
            background: none;
            border: none;
            font-size: 18px;
            color: #999;
            cursor: pointer;
            padding: 0;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .notification-close:hover {
            color: #666;
        }
        
        .notification-message {
            font-size: 13px;
            line-height: 1.4;
            color: #333;
        }
        
        .notification-details {
            margin-top: 8px;
            padding: 8px;
            background: rgba(0, 0, 0, 0.05);
            border-radius: 4px;
            font-size: 12px;
            font-family: monospace;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
        
        /* Loading State Improvements */
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            z-index: 10;
        }
        
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Enhanced Form Error States */
        .form-error {
            border-color: #e74c3c !important;
            background-color: #fdf2f2;
        }
        
        .form-error-message {
            color: #e74c3c;
            font-size: 12px;
            margin-top: 4px;
            display: block;
        }
        
        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .logout-button {
            background-color: #e74c3c;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            text-decoration: none;
            font-size: 14px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .logout-button:hover {
            background-color: #c0392b;
        }
        
        .connection-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            margin-bottom: 10px;
        }
        
        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            background-color: #28a745;
        }
        
        .real-time-badge {
            background-color: #28a745;
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 11px;
            margin-left: 8px;
        }
        
        .test-section {
            margin-top: 30px;
        }
        
        .test-section h2 {
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .test-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .test-card h3 {
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .test-status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
        }
        
        .test-status.ready {
            background-color: #d4edda;
            color: #155724;
        }
        
        .test-status.running {
            background-color: #cfe2ff;
            color: #084298;
        }
        
        .test-status.passed {
            background-color: #d1e7dd;
            color: #0f5132;
        }
        
        .test-status.failed {
            background-color: #f8d7da;
            color: #842029;
        }
        
        .test-status.pending {
            background-color: #fff3cd;
            color: #856404;
        }

        .test-status.skipped {
            background-color: #fff3cd;
            color: #856404;
        }
        
        .test-button {
            background-color: #0d6efd;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            transition: background-color 0.3s;
            margin-top: 10px;
        }
        
        .test-button:hover:not(:disabled) {
            background-color: #0b5ed7;
        }
        
        .test-button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        
        .test-details {
            margin-top: 10px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 4px;
            font-size: 14px;
            display: none;
        }
        
        .test-details.show {
            display: block;
        }
        
        .loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .run-tests-button {
            background-color: #27ae60;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s;
            margin-top: 20px;
        }
        
        .run-tests-button:hover {
            background-color: #229954;
        }
        
        .welcome-section {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        /* Custom AI Testing Styles */
        .custom-test-form {
            margin-top: 15px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }
        
        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
        }
        
        .form-group textarea {
            resize: vertical;
            font-family: inherit;
        }
        
        .form-group small {
            display: block;
            margin-top: 5px;
            color: #666;
            font-size: 12px;
        }
        
        .custom-test-results {
            margin-top: 15px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 4px;
            border-left: 4px solid #007bff;
            font-size: 14px;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .custom-test-results.success {
            border-left-color: #28a745;
            background-color: #d4edda;
        }
        
        .custom-test-results.error {
            border-left-color: #dc3545;
            background-color: #f8d7da;
        }

        /* Enhanced formatting for custom test results */
        .custom-test-success h4 {
            color: #28a745;
            margin-bottom: 1rem;
            font-size: 1.1rem;
        }

        .test-details-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            padding: 1rem;
            background-color: #f8f9fa;
            border-radius: 0.375rem;
            border: 1px solid #e9ecef;
        }

        .detail-item {
            padding: 0.25rem 0;
            font-size: 0.9rem;
        }

        .response-section {
            margin-top: 1rem;
        }

        .response-section h5 {
            color: #495057;
            margin-bottom: 0.75rem;
            font-size: 1rem;
        }

        .response-preview, .response-full, .response-content {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 0.375rem;
            padding: 1rem;
        }

        .response-preview pre, .response-full pre, .response-content pre {
            background: none;
            border: none;
            padding: 0;
            margin: 0;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-size: 0.875rem;
            line-height: 1.5;
        }

        .response-meta {
            color: #6c757d;
            font-size: 0.8rem;
            margin: 0.5rem 0;
            font-style: italic;
        }

        /* Document Intelligence specific styles */
        .document-structure {
            margin: 1.5rem 0;
            padding: 1rem;
            background-color: #e7f3ff;
            border-radius: 0.375rem;
            border: 1px solid #b3d9ff;
        }

        .document-structure h5 {
            color: #0066cc;
            margin-bottom: 0.75rem;
            font-size: 1rem;
        }

        .structure-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 0.5rem;
        }

        .structure-item {
            padding: 0.25rem 0;
            font-size: 0.9rem;
        }

        .analysis-request, .analysis-response {
            margin: 1rem 0;
            padding: 1rem;
            background-color: #f0f8ff;
            border-radius: 0.375rem;
            border: 1px solid #cce7ff;
        }

        .analysis-request h5, .analysis-response h5 {
            color: #0066cc;
            margin-bottom: 0.75rem;
            font-size: 1rem;
        }

        .request-content, .response-content {
            font-size: 0.9rem;
            line-height: 1.5;
        }

        .extracted-content {
            margin: 1.5rem 0;
            padding: 1rem;
            background-color: #f8f9fa;
            border-radius: 0.375rem;
            border: 1px solid #e9ecef;
        }

        .extracted-content h5 {
            color: #495057;
            margin-bottom: 0.75rem;
            font-size: 1rem;
        }

        .content-preview, .content-full, .content-display {
            background-color: white;
            border: 1px solid #e9ecef;
            border-radius: 0.375rem;
            padding: 1rem;
            margin-top: 0.5rem;
        }

        .content-text {
            background: none;
            border: none;
            padding: 0;
            margin: 0;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-size: 0.875rem;
            line-height: 1.5;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .content-meta {
            color: #6c757d;
            font-size: 0.8rem;
            margin: 0.5rem 0;
            font-style: italic;
        }

        /* Embedding Test Results Styles */
        .embedding-test-success {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: 1px solid #dee2e6;
            border-radius: 12px;
            padding: 1.5rem;
            margin: 1rem 0;
        }

        .embedding-summary {
            background: white;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .embedding-header-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .stat-item {
            background: #f8f9fa;
            padding: 0.75rem;
            border-radius: 6px;
            border-left: 3px solid #007bff;
            font-size: 0.9rem;
        }

        .embedding-details {
            background: white;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .embedding-stat-item {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 1rem;
            margin-bottom: 0.75rem;
        }

        .stat-header {
            font-weight: 600;
            color: #495057;
            margin-bottom: 0.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #dee2e6;
        }

        .stat-details {
            font-size: 0.9rem;
        }

        .stat-row {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin-bottom: 0.25rem;
        }

        .stat-label {
            font-weight: 500;
            color: #6c757d;
            min-width: 80px;
        }

        .stat-value {
            font-family: 'Courier New', monospace;
            background: #e9ecef;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.85rem;
        }

        .similarity-analysis {
            background: white;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .similarity-grid {
            display: grid;
            gap: 0.75rem;
        }

        .similarity-item {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .similarity-item.high-similarity {
            border-left: 4px solid #28a745;
            background: linear-gradient(90deg, #d4edda 0%, #f8f9fa 100%);
        }

        .similarity-item.medium-similarity {
            border-left: 4px solid #ffc107;
            background: linear-gradient(90deg, #fff3cd 0%, #f8f9fa 100%);
        }

        .similarity-item.low-similarity {
            border-left: 4px solid #6c757d;
            background: linear-gradient(90deg, #e2e3e5 0%, #f8f9fa 100%);
        }

        .similarity-texts {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            flex: 1;
        }

        .text-preview {
            background: white;
            padding: 0.5rem;
            border-radius: 4px;
            border: 1px solid #dee2e6;
            font-size: 0.85rem;
            font-style: italic;
            color: #495057;
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .similarity-arrow {
            font-size: 1.2rem;
            color: #6c757d;
            font-weight: bold;
        }

        .similarity-score {
            background: #007bff;
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
            min-width: 80px;
            text-align: center;
        }

        .usage-info {
            background: #e3f2fd;
            border: 1px solid #bbdefb;
            border-radius: 6px;
            padding: 0.75rem;
            text-align: center;
        }

        .usage-item {
            color: #1976d2;
            font-weight: 500;
        }

        @media (max-width: 768px) {
            .embedding-header-stats {
                grid-template-columns: 1fr;
            }

            .similarity-texts {
                flex-direction: column;
                gap: 0.5rem;
            }

            .text-preview {
                max-width: none;
                width: 100%;
            }

            .similarity-item {
                flex-direction: column;
                gap: 0.5rem;
            }
        }

        /* Document Intelligence Test Results Styles */
        .document-intelligence-success {
            background: linear-gradient(135deg, #f0f8ff 0%, #e6f3ff 100%);
            border: 1px solid #b3d9ff;
            border-radius: 12px;
            padding: 1.5rem;
            margin: 1rem 0;
        }

        .document-summary {
            background: white;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .document-header-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .document-structure-section {
            background: white;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .structure-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-top: 0.75rem;
        }

        .structure-item {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 1rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            transition: all 0.2s ease;
        }

        .structure-item.has-content {
            background: linear-gradient(135deg, #d4edda 0%, #f8f9fa 100%);
            border-color: #28a745;
            border-left: 4px solid #28a745;
        }

        .structure-item.no-content {
            background: linear-gradient(135deg, #f8d7da 0%, #f8f9fa 100%);
            border-color: #6c757d;
            border-left: 4px solid #6c757d;
        }

        .structure-icon {
            font-size: 1.5rem;
            min-width: 30px;
            text-align: center;
        }

        .structure-info {
            flex: 1;
        }

        .structure-label {
            font-size: 0.85rem;
            color: #6c757d;
            font-weight: 500;
            margin-bottom: 0.25rem;
        }

        .structure-value {
            font-size: 1.25rem;
            font-weight: 700;
            color: #495057;
            font-family: 'Courier New', monospace;
        }

        .analysis-section {
            background: white;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .analysis-request-box, .analysis-response-box {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            margin-bottom: 0.75rem;
            overflow: hidden;
        }

        .analysis-request-box {
            border-left: 4px solid #17a2b8;
        }

        .analysis-response-box {
            border-left: 4px solid #28a745;
        }

        .analysis-header {
            background: #e9ecef;
            padding: 0.5rem 1rem;
            border-bottom: 1px solid #dee2e6;
        }

        .analysis-label {
            font-weight: 600;
            color: #495057;
            font-size: 0.9rem;
        }

        .analysis-content {
            padding: 1rem;
            color: #495057;
            line-height: 1.5;
            font-style: italic;
        }

        .extracted-content-section {
            background: white;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .content-preview-box, .content-full-box {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            overflow: hidden;
        }

        .content-display {
            background: #ffffff;
            border-bottom: 1px solid #e9ecef;
        }

        .content-text {
            padding: 1rem;
            margin: 0;
            font-family: 'Courier New', monospace;
            font-size: 0.875rem;
            line-height: 1.4;
            color: #495057;
            background: transparent;
            border: none;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .content-meta {
            padding: 0.75rem 1rem;
            background: #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
        }

        .content-stats {
            font-size: 0.8rem;
            color: #6c757d;
            font-weight: 500;
        }

        .btn-icon {
            margin-right: 0.25rem;
        }

        @media (max-width: 768px) {
            .document-header-stats, .structure-grid {
                grid-template-columns: 1fr;
            }

            .content-meta {
                flex-direction: column;
                gap: 0.5rem;
                align-items: stretch;
            }

            .content-meta button {
                width: 100%;
            }
        }

        /* Enhanced Test Result Formatting Styles */
        .test-result-enhanced {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            margin-bottom: 1rem;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .result-header {
            padding: 1rem;
            border-bottom: 1px solid #dee2e6;
            position: relative;
        }

        .result-header.success {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            border-bottom-color: #c3e6cb;
        }

        .result-header.error {
            background: linear-gradient(135deg, #f8d7da 0%, #f1c2c7 100%);
            border-bottom-color: #f1c2c7;
        }

        .result-header.warning {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            border-bottom-color: #ffeaa7;
        }

        .result-header h4 {
            margin: 0 0 0.5rem 0;
            font-size: 1.25rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .test-meta {
            display: flex;
            gap: 1rem;
            font-size: 0.875rem;
            color: #6c757d;
        }

        .test-meta span {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .result-message {
            padding: 1rem;
            background: white;
        }

        .result-message p {
            margin: 0;
            font-size: 1rem;
            line-height: 1.5;
        }

        .sub-tests-section {
            padding: 1rem;
            background: #ffffff;
            border-top: 1px solid #dee2e6;
        }

        .sub-tests-section h5 {
            margin: 0 0 1rem 0;
            font-size: 1.1rem;
            font-weight: 600;
            color: #495057;
        }

        .sub-tests-grid {
            display: grid;
            gap: 0.75rem;
        }

        .sub-test-item {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 0.75rem;
            transition: all 0.2s ease;
        }

        .sub-test-item:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .sub-test-item.sub-test-success {
            border-left: 4px solid #28a745;
            background: linear-gradient(135deg, #f8fff9 0%, #f0fff4 100%);
        }

        .sub-test-item.sub-test-error {
            border-left: 4px solid #dc3545;
            background: linear-gradient(135deg, #fff8f8 0%, #fff0f0 100%);
        }

        .sub-test-header {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #495057;
        }

        .sub-test-message {
            color: #6c757d;
            line-height: 1.4;
            margin-bottom: 0.5rem;
        }

        .database-list, .extensions-section {
            margin-top: 0.75rem;
            padding: 0.5rem 0;
        }

        .database-list h6, .extensions-section h6 {
            margin: 0 0 0.5rem 0;
            font-size: 0.9rem;
            font-weight: 600;
            color: #495057;
        }

        .database-item, .extension-item {
            padding: 0.25rem 0;
            color: #6c757d;
            font-size: 0.875rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .database-item .size, .extension-item .version {
            color: #007bff;
            font-weight: 500;
        }

        .certificate-analysis {
            margin-top: 0.75rem;
            padding: 0.75rem;
            background: #f1f3f4;
            border-radius: 6px;
            border: 1px solid #e1e5e9;
        }

        .certificate-analysis h6 {
            margin: 0 0 0.5rem 0;
            font-size: 0.9rem;
            font-weight: 600;
            color: #495057;
        }

        .chain-details {
            margin-bottom: 0.75rem;
        }

        .chain-item {
            padding: 0.25rem 0;
            color: #6c757d;
            font-size: 0.875rem;
        }

        .certificate-list {
            margin-top: 0.5rem;
        }

        .certificate-item {
            padding: 0.5rem;
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            margin-bottom: 0.5rem;
        }

        .cert-position {
            font-weight: 600;
            color: #495057;
            margin-bottom: 0.25rem;
        }

        .cert-detail {
            font-size: 0.875rem;
            color: #6c757d;
            margin-bottom: 0.25rem;
        }

        .chain-analysis {
            margin-top: 0.5rem;
            padding: 0.5rem;
            background: #e3f2fd;
            border-radius: 4px;
            font-size: 0.875rem;
            color: #1565c0;
        }

        .troubleshooting {
            margin-top: 0.5rem;
        }

        .troubleshooting h6 {
            margin: 0 0 0.5rem 0;
            font-size: 0.9rem;
            font-weight: 600;
            color: #495057;
        }

        .troubleshooting-tip {
            padding: 0.25rem 0;
            color: #856404;
            font-size: 0.875rem;
            background: #fff3cd;
            padding: 0.5rem;
            border-radius: 4px;
            margin-bottom: 0.25rem;
            border-left: 3px solid #ffc107;
        }

        .remediation {
            margin-top: 0.5rem;
            padding: 0.5rem;
            background: #e7f3ff;
            border-left: 3px solid #007bff;
            border-radius: 4px;
            font-size: 0.875rem;
            color: #004085;
        }

        .remediation-section {
            padding: 1rem;
            background: #f8f9fa;
            border-top: 1px solid #dee2e6;
        }

        .remediation-section h5 {
            margin: 0 0 0.75rem 0;
            font-size: 1.1rem;
            font-weight: 600;
            color: #495057;
        }

        .remediation-content {
            background: #e7f3ff;
            border-left: 4px solid #007bff;
            padding: 0.75rem;
            border-radius: 4px;
            color: #004085;
            line-height: 1.5;
        }

        .logs-section {
            padding: 1rem;
            background: #f8f9fa;
            border-top: 1px solid #dee2e6;
        }

        .logs-section h5 {
            margin: 0 0 0.75rem 0;
            font-size: 1.1rem;
            font-weight: 600;
            color: #495057;
        }

        .logs-content {
            background: #f1f3f4;
            padding: 0.75rem;
            border-radius: 6px;
            border: 1px solid #e1e5e9;
            font-family: 'Courier New', monospace;
            font-size: 0.875rem;
            max-height: 200px;
            overflow-y: auto;
        }

        .log-entry {
            padding: 0.25rem 0;
            color: #495057;
            border-bottom: 1px solid #e9ecef;
        }

        .log-entry:last-child {
            border-bottom: none;
        }

        /* Test-specific color themes */
        .postgresql-result .result-header.success {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
        }

        .blob-result .result-header.success {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
        }

        .cassandra-result .result-header.success {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
        }

        .ssl-result .result-header.success {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
        }

        .k8s-result .result-header.success {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
        }

        .llama-result .result-header.success {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
        }

        /* Warning styles for skipped tests */
        .postgresql-result .result-header.warning {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
        }

        .blob-result .result-header.warning {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
        }

        .cassandra-result .result-header.warning {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
        }

        .ssl-result .result-header.warning {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
        }

        .k8s-result .result-header.warning {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
        }

        .llama-result .result-header.warning {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
        }
        .embedding-result .result-header.success {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
        }
        .embedding-result .result-header.warning {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
        }

        /* Responsive design for enhanced results */
        @media (max-width: 768px) {
            .test-meta {
                flex-direction: column;
                gap: 0.5rem;
            }

            .sub-tests-grid {
                gap: 0.5rem;
            }

            .certificate-item {
                padding: 0.5rem;
            }

            .database-item, .extension-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.25rem;
            }
        }
    </style>
</head>
<body>
    <!-- Notification System -->
    <div class="notification-container" id="notificationContainer"></div>
    
    <div class="container">
        <header class="dashboard-header">
            <div>
                <h1>{{ title }}</h1>
                <div class="connection-status">
                    <span class="status-indicator" id="connectionIndicator"></span>
                    <span id="connectionStatus">Manual refresh mode</span>
                    <span class="real-time-badge">READY</span>
                </div>
            </div>
            <div class="user-info">
                <span>Welcome, <strong>{{ username }}</strong></span>
                <a href="/logout" class="logout-button">Logout</a>
            </div>
        </header>
        
        <main>
            <div class="welcome-section">
                <h2>Infrastructure Readiness Dashboard</h2>
                <p>This dashboard helps you validate your infrastructure before deploying the main application. Run tests to check connectivity to all required services.</p>
                
                <button class="run-tests-button" onclick="runAllTests()" id="runAllTestsBtn">
                    Run All Tests
                </button>
            </div>
            
            <!-- Storage Tests Section -->
            <div class="test-section">
                <h2>💾 Storage Tests</h2>
                <div class="test-grid">
                    <div class="test-card" id="blobstorage-card">
                    <h3>Azure Blob Storage</h3>
                    <p>Tests authentication and file operations</p>
                    <span class="test-status ready" id="blobstorage-status">Ready to Test</span>
                    <button class="test-button" onclick="runTest('blobstorage')" id="blobstorage-btn">Run Test</button>
                    <div class="test-details" id="blobstorage-details"></div>
                </div>
                
                <div class="test-card" id="s3-card">
                    <h3>Amazon S3 Storage</h3>
                    <p>Tests S3 connectivity and operations</p>
                    <span class="test-status ready" id="s3-status">Ready to Test</span>
                    <button class="test-button" onclick="runTest('s3')" id="s3-btn">Run Test</button>
                    <div class="test-details" id="s3-details"></div>
                </div>
                
                <div class="test-card" id="minio-card">
                    <h3>Minio Storage</h3>
                    <p>Tests S3-compatible storage connectivity</p>
                    <span class="test-status ready" id="minio-status">Ready to Test</span>
                    <button class="test-button" onclick="runTest('minio')" id="minio-btn">Run Test</button>
                    <div class="test-details" id="minio-details"></div>
                </div>
            </div>
            </div>
            
            <!-- Database Tests Section -->
            <div class="test-section">
                <h2>🗄️ Database Tests</h2>
                <div class="test-grid">
                    <div class="test-card" id="postgresqlv2-card">
                        <h3>PostgreSQL Database</h3>
                        <p>Tests connection, databases, and extensions</p>
                        <span class="test-status ready" id="postgresqlv2-status">Ready to Test</span>
                        <button class="test-button" onclick="runTest('postgresqlv2')" id="postgresqlv2-btn">Run Test</button>
                        <div class="test-details" id="postgresqlv2-details"></div>
                    </div>
                    
                    <div class="test-card" id="cassandra-card">
                        <h3>Apache Cassandra</h3>
                        <p>Tests connectivity, keyspaces, and cluster health</p>
                        <span class="test-status ready" id="cassandra-status">Ready to Test</span>
                        <button class="test-button" onclick="runTest('cassandra')" id="cassandra-btn">Run Test</button>
                        <div class="test-details" id="cassandra-details"></div>
                    </div>
                </div>
            </div>
            
            <!-- AI & ML Tests Section -->
            <div class="test-section">
                <h2>🤖 AI & Machine Learning Tests</h2>
                <div class="test-grid">
                    <div class="test-card" id="openai-card">
                    <h3>AI Models (OpenAI/Llama)</h3>
                    <p>Tests API connectivity and models</p>
                    <span class="test-status ready" id="openai-status">Ready to Test</span>
                    <button class="test-button" onclick="runTest('openai')" id="openai-btn">Run Test</button>
                    <div class="test-details" id="openai-details"></div>
                </div>
                
                <div class="test-card" id="llama-card">
                    <h3>Llama Model</h3>
                    <p>Tests Llama model connectivity and text generation</p>
                    <span class="test-status ready" id="llama-status">Ready to Test</span>
                    <button class="test-button" onclick="runTest('llama')" id="llama-btn">Run Test</button>
                    <div class="test-details" id="llama-details"></div>
                </div>
                
                <div class="test-card" id="docintel-card">
                    <h3>Document Intelligence</h3>
                    <p>Tests document processing API</p>
                    <span class="test-status ready" id="docintel-status">Ready to Test</span>
                    <button class="test-button" onclick="runTest('docintel')" id="docintel-btn">Run Test</button>
                    <div class="test-details" id="docintel-details"></div>
                </div>
                
                <div class="test-card" id="embeddings-card">
                    <h3>Embedding Models</h3>
                    <p>Tests OpenAI-compatible embedding endpoints</p>
                    <span class="test-status ready" id="embeddings-status">Ready to Test</span>
                    <button class="test-button" onclick="runTest('embeddings')" id="embeddings-btn">Run Test</button>
                    <div class="test-details" id="embeddings-details"></div>
                </div>
            </div>
            </div>
            
            <!-- Infrastructure Tests Section -->
            <div class="test-section">
                <h2>🏗️ Infrastructure Tests</h2>
                <div class="test-grid">
                    <div class="test-card" id="pvc-card">
                    <h3>Kubernetes PVC</h3>
                    <p>Tests storage class and permissions</p>
                    <span class="test-status ready" id="pvc-status">Ready to Test</span>
                    <button class="test-button" onclick="runTest('pvc')" id="pvc-btn">Run Test</button>
                    <div class="test-details" id="pvc-details"></div>
                </div>
                
                <div class="test-card" id="ssl-card">
                    <h3>SSL Certificates</h3>
                    <p>Validates certificate chains</p>
                    <span class="test-status ready" id="ssl-status">Ready to Test</span>
                    <button class="test-button" onclick="runTest('ssl')" id="ssl-btn">Run Test</button>
                    <div class="test-details" id="ssl-details"></div>
                </div>

                <div class="test-card" id="gpu-card">
                    <h3>GPU Detection</h3>
                    <p>Detects and validates GPU availability, driver, and CUDA installation</p>
                    <span class="test-status ready" id="gpu-status">Ready to Test</span>
                    <button class="test-button" onclick="runTest('gpu')" id="gpu-btn">Run Test</button>
                    <div class="test-details" id="gpu-details"></div>
                </div>
            </div>
            </div>
            
            <!-- Custom AI Testing Section -->
            <div class="test-section">
                <h2>🎯 Custom AI Model Testing</h2>
                <p>Test your AI models with custom prompts and file content</p>
                <div class="test-grid">
                    <div class="test-card" id="custom-openai-card">
                        <h3>Custom OpenAI Test</h3>
                        <p>Send custom prompts and files to OpenAI models</p>
                        <form id="custom-openai-form" class="custom-test-form">
                            <div class="form-group">
                                <label for="openai-prompt">Your Prompt:</label>
                                <textarea id="openai-prompt" name="prompt" placeholder="Enter your custom prompt here..." rows="3" required></textarea>
                            </div>
                            <div class="form-group">
                                <label for="openai-system">System Message (optional):</label>
                                <input type="text" id="openai-system" name="system_message" placeholder="You are a helpful assistant...">
                            </div>
                            <div class="form-group">
                                <label for="openai-file">Upload File (optional):</label>
                                <input type="file" id="openai-file" name="file" accept=".txt,.md,.json,.csv,.log,.pdf,.jpg,.jpeg,.png">
                                <small>Max 25MB, supports: text files, PDF, images (JPG, PNG)</small>
                            </div>
                            <button type="submit" class="test-button">Test OpenAI</button>
                        </form>
                        <div class="test-details" id="custom-openai-results"></div>
                    </div>
                    
                    <div class="test-card" id="custom-llama-card">
                        <h3>Custom Llama Test</h3>
                        <p>Send custom prompts and files to Llama models</p>
                        <form id="custom-llama-form" class="custom-test-form">
                            <div class="form-group">
                                <label for="llama-prompt">Your Prompt:</label>
                                <textarea id="llama-prompt" name="prompt" placeholder="Enter your custom prompt here..." rows="3" required></textarea>
                            </div>
                            <div class="form-group">
                                <label for="llama-system">System Message (optional):</label>
                                <input type="text" id="llama-system" name="system_message" placeholder="You are a helpful assistant...">
                            </div>
                            <div class="form-group">
                                <label for="llama-file">Upload File (optional):</label>
                                <input type="file" id="llama-file" name="file" accept=".txt,.md,.json,.csv,.log,.pdf,.jpg,.jpeg,.png">
                                <small>Max 25MB, supports: text files, PDF, images (JPG, PNG)</small>
                            </div>
                            <button type="submit" class="test-button">Test Llama</button>
                        </form>
                        <div class="test-details" id="custom-llama-results"></div>
                    </div>
                    
                    <div class="test-card" id="custom-docintel-card">
                        <h3>Custom Document Intelligence Test</h3>
                        <p>Upload documents for Azure Document Intelligence analysis</p>
                        <form id="custom-docintel-form" class="custom-test-form">
                            <div class="form-group">
                                <label for="docintel-prompt">Analysis Request (optional):</label>
                                <textarea id="docintel-prompt" name="prompt" placeholder="Describe what you want to analyze in this document..." rows="2"></textarea>
                            </div>
                            <div class="form-group">
                                <label for="docintel-file">Upload Document (required):</label>
                                <input type="file" id="docintel-file" name="file" accept=".pdf,.jpg,.jpeg,.png,.bmp,.tiff,.tif,.docx,.xlsx,.pptx" required>
                                <small>Max 25MB, supports: PDF, images, Office documents</small>
                            </div>
                            <button type="submit" class="test-button">Analyze Document</button>
                        </form>
                        <div class="test-details" id="custom-docintel-results"></div>
                    </div>
                    
                    <div class="test-card" id="custom-embeddings-card">
                        <h3>Custom Embedding Test</h3>
                        <p>Generate embeddings for custom text with similarity analysis</p>
                        <form id="custom-embeddings-form" class="custom-test-form">
                            <div class="form-group">
                                <label for="embeddings-text">Primary Text (required):</label>
                                <textarea id="embeddings-text" name="text" placeholder="Enter text to generate embeddings for..." rows="3" required></textarea>
                            </div>
                            <div class="form-group">
                                <label for="embeddings-batch">Additional Texts (optional):</label>
                                <textarea id="embeddings-batch" name="batch_texts" placeholder="Enter additional texts separated by commas for similarity comparison..." rows="2"></textarea>
                                <small>Separate multiple texts with commas for batch processing and similarity analysis</small>
                            </div>
                            <button type="submit" class="test-button">Generate Embeddings</button>
                        </form>
                        <div class="test-details" id="custom-embeddings-results"></div>
                    </div>
                </div>
            </div>
        </main>
        
        <footer>
            <p>Airia Infrastructure Test Pod <span id="version-display">Loading...</span></p>
        </footer>
    </div>
    
    <script>
        // Enhanced Notification System
        class NotificationManager {
            constructor() {
                this.container = document.getElementById('notificationContainer');
                this.notifications = new Map();
            }
            
            show(type, title, message, details = null, duration = 5000) {
                const id = Date.now().toString();
                
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.id = `notification-${id}`;
                
                const icon = this.getIcon(type);
                
                notification.innerHTML = `
                    <div class="notification-header">
                        <span class="notification-title">${icon} ${title}</span>
                        <button class="notification-close" onclick="notificationManager.remove('${id}')">×</button>
                    </div>
                    <div class="notification-message">${message}</div>
                    ${details ? `<div class="notification-details">${details}</div>` : ''}
                `;
                
                this.container.appendChild(notification);
                this.notifications.set(id, notification);
                
                // Auto-remove after duration (except for error notifications)
                if (type !== 'error' && duration > 0) {
                    setTimeout(() => this.remove(id), duration);
                }
                
                return id;
            }
            
            remove(id) {
                const notification = this.notifications.get(id);
                if (notification) {
                    notification.style.animation = 'slideOut 0.3s ease-out';
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                        this.notifications.delete(id);
                    }, 300);
                }
            }
            
            clear() {
                this.notifications.forEach((_, id) => this.remove(id));
            }
            
            getIcon(type) {
                const icons = {
                    success: '✅',
                    error: '❌',
                    warning: '⚠️',
                    info: 'ℹ️'
                };
                return icons[type] || 'ℹ️';
            }
            
            // Convenience methods
            success(title, message, details = null) {
                return this.show('success', title, message, details);
            }
            
            error(title, message, details = null) {
                return this.show('error', title, message, details, 0); // Don't auto-remove errors
            }
            
            warning(title, message, details = null) {
                return this.show('warning', title, message, details);
            }
            
            info(title, message, details = null) {
                return this.show('info', title, message, details);
            }
        }
        
        // Initialize notification manager
        const notificationManager = new NotificationManager();
        
        // Enhanced Error Handling Functions
        function handleApiError(error, context = 'Operation') {
            console.error(`${context} error:`, error);
            
            const status = error.response?.status;
            let title, message, details;
            
            // Handle different error types
            switch (status) {
                case 401:
                case 403:
                    title = 'Authentication Required';
                    message = 'Your session has expired. Please log in again.';
                    setTimeout(() => {
                        window.location.href = '/login';
                    }, 2000);
                    break;
                    
                case 404:
                    title = 'Service Not Found';
                    message = 'The requested service or endpoint could not be found.';
                    details = `URL: ${error.config?.url || 'Unknown'}`;
                    break;
                    
                case 422:
                    title = 'Validation Error';
                    message = 'The provided data is invalid or incomplete.';
                    details = error.response?.data?.detail || 'Please check your input and try again.';
                    break;
                    
                case 424:
                    title = 'Service Dependency Failed';
                    message = 'A required service is not properly configured or unavailable.';
                    details = error.response?.data?.detail || 'Check service configuration.';
                    break;
                    
                case 500:
                    title = 'Server Error';
                    message = 'An internal server error occurred. Please try again later.';
                    details = error.response?.data?.detail || error.message;
                    break;
                    
                case 503:
                    title = 'Service Unavailable';
                    message = 'The service is temporarily unavailable. Please try again later.';
                    break;
                    
                default:
                    if (error.code === 'NETWORK_ERROR' || !error.response) {
                        title = 'Network Error';
                        message = 'Unable to connect to the server. Check your connection and try again.';
                        details = 'This might be a temporary network issue.';
                    } else {
                        title = 'Unexpected Error';
                        message = error.response?.data?.detail || error.message || 'An unknown error occurred.';
                        details = `Status: ${status} | ${context}`;
                    }
            }
            
            notificationManager.error(title, message, details);
        }
        
        function showLoadingState(element, text = 'Loading...') {
            if (!element) return;
            
            const loadingOverlay = document.createElement('div');
            loadingOverlay.className = 'loading-overlay';
            loadingOverlay.innerHTML = `
                <div class="loading-spinner"></div>
                <span>${text}</span>
            `;
            
            element.style.position = 'relative';
            element.appendChild(loadingOverlay);
            return loadingOverlay;
        }
        
        function hideLoadingState(loadingOverlay) {
            if (loadingOverlay && loadingOverlay.parentNode) {
                loadingOverlay.parentNode.removeChild(loadingOverlay);
            }
        }

        // Initialize dashboard
        window.addEventListener('load', function() {
            checkTestStatus(); // Load current test status
            loadVersion(); // Load dynamic version
        });
        
        // Load version dynamically
        async function loadVersion() {
            try {
                const response = await fetch('/version');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                const data = await response.json();
                document.getElementById('version-display').textContent = 'v' + data.version;
            } catch (error) {
                // Silently fail version loading - not critical for functionality
                console.warn('Version loading failed (non-critical):', error.message);
                // FALLBACK_VERSION: This line gets updated by automated versioning
                document.getElementById('version-display').textContent = 'v1.0.158';
            }
        }
        
        // Test functions
        async function runTest(testName) {
            const statusElement = document.getElementById(`${testName}-status`);
            const buttonElement = document.getElementById(`${testName}-btn`);
            const detailsElement = document.getElementById(`${testName}-details`);
            
            // Update UI to show running
            statusElement.textContent = 'Running...';
            statusElement.className = 'test-status running';
            buttonElement.disabled = true;
            buttonElement.innerHTML = 'Running <span class="loading-spinner"></span>';
            detailsElement.classList.remove('show');
            
            try {
                // Use existing session authentication (cookies)
                const response = await axios.post(`/api/tests/${testName}`);
                const result = response.data;
                
                // Update status based on result
                const testResult = result.result || result;
                if (testResult.status === 'passed') {
                    statusElement.textContent = 'Passed';
                    statusElement.className = 'test-status passed';
                } else if (testResult.status === 'failed') {
                    statusElement.textContent = 'Failed';
                    statusElement.className = 'test-status failed';
                } else if (testResult.status === 'skipped') {
                    statusElement.textContent = 'Skipped';
                    statusElement.className = 'test-status pending';
                }
                
                // Show details
                detailsElement.innerHTML = formatTestDetails(testResult, testName);
                detailsElement.classList.add('show');
                
            } catch (error) {
                statusElement.textContent = 'Error';
                statusElement.className = 'test-status failed';
                detailsElement.innerHTML = `<strong>Error:</strong> ${error.response?.data?.detail || error.message}`;
                detailsElement.classList.add('show');
                
                // Also show a notification for the error
                handleApiError(error, `${testName} test`);
            } finally {
                buttonElement.disabled = false;
                buttonElement.innerHTML = 'Run Test';
            }
        }
        
        async function runAllTests() {
            const button = document.getElementById('runAllTestsBtn');
            button.disabled = true;
            button.innerHTML = 'Running All Tests <span class="loading-spinner"></span>';
            
            try {
                // Use existing session authentication (cookies)
                const response = await axios.post('/api/tests/run-all');
                const data = response.data;
                const results = data.results || {};
                
                // Update individual test results
                for (const [testId, result] of Object.entries(results)) {
                    const statusElement = document.getElementById(`${testId}-status`);
                    const detailsElement = document.getElementById(`${testId}-details`);
                    
                    if (statusElement) {
                        if (result.status === 'passed') {
                            statusElement.textContent = 'Passed';
                            statusElement.className = 'test-status passed';
                        } else if (result.status === 'failed') {
                            statusElement.textContent = 'Failed';
                            statusElement.className = 'test-status failed';
                        } else if (result.status === 'skipped') {
                            statusElement.textContent = 'Skipped';
                            statusElement.className = 'test-status skipped';
                        }
                        
                        if (detailsElement) {
                            detailsElement.innerHTML = formatTestDetails(result, testId);
                            detailsElement.classList.add('show');
                        }
                    }
                }
                
                // Show overall summary
                if (data.overall_status) {
                    const message = `${data.passed_count || 0} passed, ${data.failed_count || 0} failed, ${data.skipped_count || 0} skipped`;
                    const notificationType = (data.failed_count > 0) ? 'warning' : 'success';
                    notificationManager.show(notificationType, 'All Tests Completed', message);
                }
                
            } catch (error) {
                handleApiError(error, 'Running all tests');
            } finally {
                button.disabled = false;
                button.innerHTML = 'Run All Tests';
            }
        }
        
        function formatTestDetails(result, testId) {
            // Use enhanced formatting based on test type
            if (testId) {
                if (testId === 'postgresql') {
                    return formatPostgreSQLResult(result);
                } else if (testId === 'blob_storage') {
                    return formatBlobStorageResult(result);
                } else if (testId === 'cassandra') {
                    return formatCassandraResult(result);
                } else if (testId === 'ssl') {
                    return formatSSLResult(result);
                } else if (testId === 'kubernetes_pvc') {
                    return formatKubernetesPVCResult(result);
                } else if (testId === 'llama') {
                    return formatLlamaResult(result);
                } else if (testId === 'embeddings') {
                    return formatEmbeddingResult(result);
                }
            }

            // Fallback to enhanced generic formatter
            const responseId = 'generic-' + Date.now();
            let html = `<div class="test-result-enhanced generic-result">`;

            // Header
            const statusIcon = result.status === 'passed' ? '✅' : '❌';
            const statusClass = result.status === 'passed' ? 'success' : 'error';
            html += `<div class="result-header ${statusClass}">`;
            html += `<h4>${statusIcon} Test Result</h4>`;
            html += `<div class="test-meta">`;
            html += `<span class="duration">⏱️ ${result.duration_seconds?.toFixed(2) || 'N/A'}s</span>`;
            html += `<span class="status">Status: ${result.status}</span>`;
            html += `</div>`;
            html += `</div>`;

            html += `<div class="result-message">`;
            html += `<p><strong>📊 Result:</strong> ${result.message}</p>`;
            html += `</div>`;

            // Sub-tests
            if (result.sub_tests) {
                html += `<div class="sub-tests-section">`;
                html += `<h5>🔍 Test Details:</h5>`;
                html += `<div class="sub-tests-grid">`;

                for (const [testName, testResult] of Object.entries(result.sub_tests)) {
                    const icon = testResult.success ? '✅' : '❌';
                    const itemClass = testResult.success ? 'sub-test-success' : 'sub-test-error';

                    html += `<div class="sub-test-item ${itemClass}">`;
                    html += `<div class="sub-test-header">${icon} <strong>${testName}</strong></div>`;
                    html += `<div class="sub-test-message">${testResult.message}</div>`;

                    if (testResult.remediation) {
                        html += `<div class="remediation">💡 <em>${testResult.remediation}</em></div>`;
                    }

                    html += `</div>`;
                }

                html += `</div>`;
                html += `</div>`;
            }

            // Logs
            if (result.logs && result.logs.length > 0) {
                html += `<div class="logs-section">`;
                html += `<h5>📝 Logs:</h5>`;
                html += `<div class="logs-content">`;
                result.logs.forEach(log => {
                    html += `<div class="log-entry">[${log.level}] ${log.message}</div>`;
                });
                html += `</div>`;
                html += `</div>`;
            }

            if (result.remediation) {
                html += `<div class="remediation-section">`;
                html += `<h5>💡 Remediation:</h5>`;
                html += `<div class="remediation-content">${result.remediation}</div>`;
                html += `</div>`;
            }

            html += `</div>`;
            return html;
        }
        
        // Check test status on page load
        async function checkTestStatus() {
            try {
                const response = await axios.get('/api/tests/status');
                const tests = response.data.tests || {};
                
                for (const [testName, testData] of Object.entries(tests)) {
                    const statusElement = document.getElementById(`${testName}-status`);
                    if (statusElement && testData.status) {
                        const lastRun = testData.last_run ? new Date(testData.last_run).toLocaleString() : 'Never';
                        
                        if (testData.status === 'passed') {
                            statusElement.textContent = `Last Run: Passed (${lastRun})`;
                            statusElement.className = 'test-status passed';
                        } else if (testData.status === 'failed') {
                            statusElement.textContent = `Last Run: Failed (${lastRun})`;
                            statusElement.className = 'test-status failed';
                        } else if (testData.status === 'skipped') {
                            statusElement.textContent = `Last Run: Skipped (${lastRun})`;
                            statusElement.className = 'test-status pending';
                        }
                    }
                }
            } catch (error) {
                // Don't spam console with status check errors - they happen during normal operation
                console.warn('Status check failed (will retry):', error.message);
            }
        }
        
        // Custom AI Testing Functions
        document.addEventListener('DOMContentLoaded', function() {
            // Handle OpenAI custom test form
            document.getElementById('custom-openai-form').addEventListener('submit', async function(e) {
                e.preventDefault();
                await handleCustomTest('openai', this);
            });
            
            // Handle Llama custom test form
            document.getElementById('custom-llama-form').addEventListener('submit', async function(e) {
                e.preventDefault();
                await handleCustomTest('llama', this);
            });
            
            // Handle Document Intelligence custom test form
            document.getElementById('custom-docintel-form').addEventListener('submit', async function(e) {
                e.preventDefault();
                await handleCustomDocIntelTest(this);
            });
            
            // Handle Embeddings custom test form
            document.getElementById('custom-embeddings-form').addEventListener('submit', async function(e) {
                e.preventDefault();
                await handleCustomEmbeddingsTest(this);
            });
        });
        
        async function handleCustomTest(testType, form) {
            const resultsElement = document.getElementById(`custom-${testType}-results`);
            const submitButton = form.querySelector('button[type="submit"]');
            
            try {
                // Disable submit button and show loading
                submitButton.disabled = true;
                submitButton.innerHTML = `Testing ${testType}... <span class="loading-spinner"></span>`;
                
                // Clear previous results
                resultsElement.innerHTML = '';
                resultsElement.className = 'test-details';
                
                // Prepare form data
                const formData = new FormData();
                formData.append('prompt', form.prompt.value);
                
                if (form.system_message.value) {
                    formData.append('system_message', form.system_message.value);
                }
                
                if (form.file.files[0]) {
                    formData.append('file', form.file.files[0]);
                }
                
                // Send request
                const response = await axios.post(`/api/tests/${testType}/custom`, formData, {
                    headers: {
                        'Content-Type': 'multipart/form-data'
                    }
                });
                
                const result = response.data;
                
                // Display results
                if (result.success) {
                    resultsElement.className = 'test-details show custom-test-results success';
                    resultsElement.innerHTML = formatCustomTestResult(result);
                    notificationManager.success('Test Completed', 'Custom AI test completed successfully!');
                } else {
                    resultsElement.className = 'test-details show custom-test-results error';
                    resultsElement.innerHTML = `❌ Test Failed: ${result.message}\\n\\n${result.remediation || ''}`;
                    notificationManager.error('Test Failed', result.message, result.remediation);
                }
                
            } catch (error) {
                resultsElement.className = 'test-details show custom-test-results error';
                const errorMessage = error.response?.data?.detail || error.message || 'Unknown error occurred';
                resultsElement.innerHTML = `❌ Error: ${errorMessage}`;
                handleApiError(error, 'Custom AI test');
            } finally {
                // Re-enable submit button
                submitButton.disabled = false;
                submitButton.innerHTML = `Test ${testType.charAt(0).toUpperCase() + testType.slice(1)}`;
            }
        }
        
        function formatCustomTestResult(result) {
            // Check if this is a Document Intelligence result
            if (result.model_used && result.document_info && result.content_preview !== undefined) {
                return formatDocumentIntelligenceResult(result);
            }

            // Check if this is an Embedding result
            if (result.embedding_stats || result.embeddings_generated || result.embedding_dimension) {
                return formatEmbeddingResult(result);
            }

            // Default Llama/AI model result formatting
            const responseText = result.response_text || '';
            const isLongResponse = responseText.length > 800;
            const responseId = 'response-' + Date.now();

            let html = `<div class="custom-test-success">`;
            html += `<h4>✅ Test Successful!</h4>`;

            // Test details in a structured format
            html += `<div class="test-details-grid">`;
            html += `<div class="detail-item"><strong>📊 Model:</strong> ${result.model}</div>`;
            html += `<div class="detail-item"><strong>⏱️ Response Time:</strong> ${result.response_time_ms}ms</div>`;

            if (result.tokens_used) {
                if (typeof result.tokens_used === 'object') {
                    html += `<div class="detail-item"><strong>🔢 Tokens:</strong> ${result.tokens_used.total_tokens} (${result.tokens_used.prompt_tokens} prompt + ${result.tokens_used.completion_tokens} completion)</div>`;
                } else {
                    html += `<div class="detail-item"><strong>🔢 Tokens:</strong> ${result.tokens_used}</div>`;
                }
            }

            if (result.file_provided) {
                let fileInfo = 'Included in analysis';
                if (result.file_type && result.file_type !== 'none') {
                    fileInfo += ` (${result.file_type.toUpperCase()})`;
                }
                html += `<div class="detail-item"><strong>📎 File:</strong> ${fileInfo}</div>`;
            }
            html += `</div>`;

            // Response section with better formatting
            html += `<div class="response-section">`;
            html += `<h5>🤖 Model Response:</h5>`;

            if (isLongResponse) {
                const preview = responseText.substring(0, 400);
                html += `<div class="response-preview" id="${responseId}-preview">`;
                html += `<pre>${preview}...</pre>`;
                html += `<div class="response-meta">Showing first 400 of ${responseText.length} characters</div>`;
                html += `<button type="button" class="btn btn-sm btn-outline-primary" onclick="toggleFullResponse('${responseId}')">View Full Response</button>`;
                html += `</div>`;

                html += `<div class="response-full" id="${responseId}-full" style="display: none;">`;
                html += `<pre>${responseText}</pre>`;
                html += `<button type="button" class="btn btn-sm btn-outline-secondary" onclick="toggleFullResponse('${responseId}')">Show Preview Only</button>`;
                html += `</div>`;
            } else {
                html += `<div class="response-content">`;
                html += `<pre>${responseText}</pre>`;
                html += `</div>`;
            }

            html += `</div></div>`;

            return html;
        }

        function formatEmbeddingResult(result) {
            const responseId = 'embedding-' + Date.now();
            let html = `<div class="test-result-enhanced embedding-result">`;

            // Header with status
            let statusIcon, statusClass;
            if (result.status === 'passed') {
                statusIcon = '✅';
                statusClass = 'success';
            } else if (result.status === 'skipped') {
                statusIcon = '⚠️';
                statusClass = 'warning';
            } else {
                statusIcon = '❌';
                statusClass = 'error';
            }

            html += `<div class="result-header ${statusClass}">`;
            html += `<h4>${statusIcon} Embedding Models Test</h4>`;
            html += `<div class="test-meta">`;
            html += `<span class="duration">⏱️ ${result.duration_seconds?.toFixed(2) || 'N/A'}s</span>`;
            html += `<span class="status">Status: ${result.status}</span>`;
            html += `</div>`;
            html += `</div>`;

            // Main message
            html += `<div class="result-message">`;
            html += `<p><strong>📊 Result:</strong> ${result.message}</p>`;
            html += `</div>`;

            // Only show detailed results if test passed
            if (result.status === 'passed') {

            // Primary metrics section
            html += `<div class="embedding-summary">`;
            html += `<div class="embedding-header-stats">`;
            html += `<span class="stat-item"><strong>📊 Model:</strong> ${result.model || 'N/A'}</span>`;
            html += `<span class="stat-item"><strong>⏱️ Processing Time:</strong> ${result.response_time_ms || 'N/A'}ms</span>`;
            html += `<span class="stat-item"><strong>🔢 Embeddings Generated:</strong> ${result.embeddings_generated || 'N/A'}</span>`;
            html += `<span class="stat-item"><strong>📐 Embedding Dimension:</strong> ${result.embedding_dimension || 'N/A'}</span>`;
            html += `</div>`;
            html += `</div>`;

            // Detailed statistics section
            if (result.embedding_stats && result.embedding_stats.length > 0) {
                html += `<div class="embedding-details">`;
                html += `<h5>📈 Embedding Statistics</h5>`;

                result.embedding_stats.forEach((stat, index) => {
                    const textPreview = stat.input_text.length > 50 ? stat.input_text.substring(0, 50) + '...' : stat.input_text;
                    html += `<div class="embedding-stat-item">`;
                    html += `<div class="stat-header">`;
                    html += `<strong>Text ${index + 1}:</strong> "${textPreview}"`;
                    html += `</div>`;
                    html += `<div class="stat-details">`;
                    html += `<div class="stat-row">`;
                    html += `<span class="stat-label">📐 Dimension:</span> <span class="stat-value">${stat.dimension}</span>`;
                    html += `<span class="stat-label">📊 Range:</span> <span class="stat-value">${stat.embedding_range.min} to ${stat.embedding_range.max}</span>`;
                    html += `</div>`;
                    html += `<div class="stat-row">`;
                    html += `<span class="stat-label">📈 Mean:</span> <span class="stat-value">${stat.embedding_range.mean}</span>`;
                    if (stat.vector_norm) {
                        html += `<span class="stat-label">🔢 Vector Norm:</span> <span class="stat-value">${stat.vector_norm}</span>`;
                    }
                    html += `</div>`;
                    html += `</div>`;
                    html += `</div>`;
                });
                html += `</div>`;
            }

            // Similarity analysis section
            if (result.similarities && result.similarities.length > 0) {
                html += `<div class="similarity-analysis">`;
                html += `<h5>🔗 Similarity Analysis</h5>`;
                html += `<div class="similarity-grid">`;

                result.similarities.forEach(sim => {
                    const similarityPercentage = Math.round(sim.similarity * 100);
                    const similarityClass = sim.similarity > 0.8 ? 'high-similarity' : sim.similarity > 0.5 ? 'medium-similarity' : 'low-similarity';

                    html += `<div class="similarity-item ${similarityClass}">`;
                    html += `<div class="similarity-texts">`;
                    html += `<div class="text-preview">"${sim.text1_preview}"</div>`;
                    html += `<div class="similarity-arrow">↔</div>`;
                    html += `<div class="text-preview">"${sim.text2_preview}"</div>`;
                    html += `</div>`;
                    html += `<div class="similarity-score">${similarityPercentage}% similar</div>`;
                    html += `</div>`;
                });

                html += `</div>`;
                html += `</div>`;
            }

                // Usage information
                if (result.total_tokens_used) {
                    html += `<div class="usage-info">`;
                    html += `<span class="usage-item"><strong>🎯 Tokens Used:</strong> ${result.total_tokens_used}</span>`;
                    html += `</div>`;
                }
            }

            html += `</div>`;
            return html;
        }

        function formatDocumentIntelligenceResult(result) {
            const responseId = 'docintel-response-' + Date.now();
            const contentPreview = result.content_preview || '';
            const isLongContent = contentPreview.length > 500;

            let html = `<div class="custom-test-success">`;
            html += `<h4>✅ Document Analysis Successful!</h4>`;

            // File and processing details
            html += `<div class="test-details-grid">`;
            html += `<div class="detail-item"><strong>📄 File Type:</strong> ${result.file_type?.toUpperCase() || 'Unknown'}</div>`;
            html += `<div class="detail-item"><strong>🤖 Model:</strong> ${result.model_used}</div>`;
            html += `<div class="detail-item"><strong>⏱️ Processing Time:</strong> ${result.processing_time_ms}ms</div>`;
            html += `<div class="detail-item"><strong>📊 Content Length:</strong> ${result.content_length} characters</div>`;
            html += `</div>`;

            // Document structure information
            if (result.document_info) {
                html += `<div class="document-structure">`;
                html += `<h5>📋 Document Structure:</h5>`;
                html += `<div class="structure-grid">`;
                html += `<div class="structure-item"><strong>📑 Pages:</strong> ${result.document_info.pages || 0}</div>`;
                html += `<div class="structure-item"><strong>📊 Tables:</strong> ${result.document_info.tables || 0}</div>`;
                html += `<div class="structure-item"><strong>📝 Paragraphs:</strong> ${result.document_info.paragraphs || 0}</div>`;
                html += `<div class="structure-item"><strong>🔑 Key-Value Pairs:</strong> ${result.document_info.key_value_pairs || 0}</div>`;
                html += `</div>`;
                html += `</div>`;
            }

            // Custom prompt and response if provided
            if (result.custom_prompt) {
                html += `<div class="analysis-request">`;
                html += `<h5>💬 Analysis Request:</h5>`;
                html += `<div class="request-content">${result.custom_prompt}</div>`;
                html += `</div>`;

                if (result.prompt_response) {
                    html += `<div class="analysis-response">`;
                    html += `<h5>🔍 Analysis Response:</h5>`;
                    html += `<div class="response-content">${result.prompt_response}</div>`;
                    html += `</div>`;
                }
            }

            // Extracted content section
            if (contentPreview) {
                html += `<div class="extracted-content">`;
                html += `<h5>📄 Extracted Content:</h5>`;

                if (isLongContent) {
                    const preview = contentPreview.substring(0, 300);
                    html += `<div class="content-preview" id="${responseId}-preview">`;
                    html += `<pre class="content-text">${preview}...</pre>`;
                    html += `<div class="content-meta">Showing first 300 of ${contentPreview.length} characters</div>`;
                    html += `<button type="button" class="btn btn-sm btn-outline-primary" onclick="toggleDocumentContent('${responseId}')">View Full Content</button>`;
                    html += `</div>`;

                    html += `<div class="content-full" id="${responseId}-full" style="display: none;">`;
                    html += `<pre class="content-text">${contentPreview}</pre>`;
                    html += `<button type="button" class="btn btn-sm btn-outline-secondary" onclick="toggleDocumentContent('${responseId}')">Show Preview Only</button>`;
                    html += `</div>`;
                } else {
                    html += `<div class="content-display">`;
                    html += `<pre class="content-text">${contentPreview}</pre>`;
                    html += `</div>`;
                }

                html += `</div>`;
            }

            html += `</div>`;

            return html;
        }

        // Function to toggle between preview and full response
        function toggleFullResponse(responseId) {
            const preview = document.getElementById(responseId + '-preview');
            const full = document.getElementById(responseId + '-full');

            if (preview.style.display !== 'none') {
                preview.style.display = 'none';
                full.style.display = 'block';
            } else {
                preview.style.display = 'block';
                full.style.display = 'none';
            }
        }

        // Function to toggle document content for Document Intelligence results
        function toggleDocumentContent(responseId) {
            const preview = document.getElementById(responseId + '-preview');
            const full = document.getElementById(responseId + '-full');

            if (preview.style.display !== 'none') {
                preview.style.display = 'none';
                full.style.display = 'block';
            } else {
                preview.style.display = 'block';
                full.style.display = 'none';
            }
        }
        
        async function handleCustomDocIntelTest(form) {
            const resultsElement = document.getElementById('custom-docintel-results');
            const submitButton = form.querySelector('button[type="submit"]');
            
            try {
                // Disable submit button and show loading
                submitButton.disabled = true;
                submitButton.innerHTML = 'Analyzing Document... <span class="loading-spinner"></span>';
                
                // Clear previous results
                resultsElement.innerHTML = '';
                resultsElement.className = 'test-details';
                
                // Check if file is selected (required for Document Intelligence)
                if (!form.file.files[0]) {
                    resultsElement.className = 'test-details show custom-test-results error';
                    resultsElement.innerHTML = '❌ Error: Please select a document to analyze';
                    notificationManager.warning('Missing File', 'Please select a document file to analyze');
                    return;
                }
                
                // Prepare form data
                const formData = new FormData();
                if (form.prompt.value) {
                    formData.append('prompt', form.prompt.value);
                }
                formData.append('file', form.file.files[0]);
                
                // Send request
                const response = await axios.post('/api/tests/docintel/custom', formData, {
                    headers: {
                        'Content-Type': 'multipart/form-data'
                    }
                });
                
                const result = response.data;
                
                // Display results
                if (result.success) {
                    resultsElement.className = 'test-details show custom-test-results success';
                    resultsElement.innerHTML = formatDocumentIntelligenceResult(result);
                } else {
                    resultsElement.className = 'test-details show custom-test-results error';
                    resultsElement.innerHTML = `❌ Analysis Failed: ${result.message}\\n\\n${result.remediation || ''}`;
                }
                
            } catch (error) {
                resultsElement.className = 'test-details show custom-test-results error';
                const errorMessage = error.response?.data?.detail || error.message || 'Unknown error occurred';
                resultsElement.innerHTML = `❌ Error: ${errorMessage}`;
                handleApiError(error, 'Custom AI test');
            } finally {
                // Re-enable submit button
                submitButton.disabled = false;
                submitButton.innerHTML = 'Analyze Document';
            }
        }
        

        // Enhanced formatting functions for all test types
        function formatPostgreSQLResult(result) {
            const responseId = 'postgres-' + Date.now();
            let html = `<div class="test-result-enhanced postgresql-result">`;

            // Header with status
            let statusIcon, statusClass;
            if (result.status === 'passed') {
                statusIcon = '✅';
                statusClass = 'success';
            } else if (result.status === 'skipped') {
                statusIcon = '⚠️';
                statusClass = 'warning';
            } else {
                statusIcon = '❌';
                statusClass = 'error';
            }
            html += `<div class="result-header ${statusClass}">`;
            html += `<h4>${statusIcon} PostgreSQL Database Test</h4>`;
            html += `<div class="test-meta">`;
            html += `<span class="duration">⏱️ ${result.duration_seconds?.toFixed(2) || 'N/A'}s</span>`;
            html += `<span class="status">Status: ${result.status}</span>`;
            html += `</div>`;
            html += `</div>`;

            // Main message
            html += `<div class="result-message">`;
            html += `<p><strong>📊 Result:</strong> ${result.message}</p>`;
            html += `</div>`;

            // Sub-tests if available
            if (result.sub_tests) {
                html += `<div class="sub-tests-section">`;
                html += `<h5>🔍 Detailed Test Results:</h5>`;
                html += `<div class="sub-tests-grid">`;

                for (const [testName, testResult] of Object.entries(result.sub_tests)) {
                    const icon = testResult.success ? '✅' : '❌';
                    const itemClass = testResult.success ? 'sub-test-success' : 'sub-test-error';

                    html += `<div class="sub-test-item ${itemClass}">`;
                    html += `<div class="sub-test-header">${icon} <strong>${testName}</strong></div>`;
                    html += `<div class="sub-test-message">${testResult.message}</div>`;

                    // Show database details
                    if (testName === 'databases' && testResult.databases) {
                        html += `<div class="database-list">`;
                        html += `<h6>📚 Databases Found:</h6>`;
                        testResult.databases.forEach(db => {
                            html += `<div class="database-item">• ${db.name} <span class="size">(${db.size_human})</span></div>`;
                        });
                        html += `</div>`;
                    }

                    // Show extension details
                    if (testName === 'extensions' && testResult.installed_extensions) {
                        html += `<div class="extensions-section">`;
                        html += `<h6>🔧 Installed Extensions:</h6>`;
                        testResult.installed_extensions.forEach(ext => {
                            html += `<div class="extension-item">• ${ext.name} <span class="version">v${ext.version}</span></div>`;
                        });

                        if (testResult.available_extensions && testResult.available_extensions.length > 0) {
                            html += `<h6>📦 Available Extensions:</h6>`;
                            testResult.available_extensions.forEach(ext => {
                                const status = ext.installed ? ' ✓' : '';
                                html += `<div class="extension-item">• ${ext.name} <span class="version">v${ext.version}${status}</span></div>`;
                            });
                        }
                        html += `</div>`;
                    }

                    if (testResult.remediation) {
                        html += `<div class="remediation">💡 <em>${testResult.remediation}</em></div>`;
                    }

                    html += `</div>`;
                }

                html += `</div>`;
                html += `</div>`;
            }

            // Remediation section
            if (result.remediation) {
                html += `<div class="remediation-section">`;
                html += `<h5>💡 Remediation:</h5>`;
                html += `<div class="remediation-content">${result.remediation}</div>`;
                html += `</div>`;
            }

            html += `</div>`;
            return html;
        }

        function formatBlobStorageResult(result) {
            const responseId = 'blob-' + Date.now();
            let html = `<div class="test-result-enhanced blob-result">`;

            // Header with status
            let statusIcon, statusClass;
            if (result.status === 'passed') {
                statusIcon = '✅';
                statusClass = 'success';
            } else if (result.status === 'skipped') {
                statusIcon = '⚠️';
                statusClass = 'warning';
            } else {
                statusIcon = '❌';
                statusClass = 'error';
            }
            html += `<div class="result-header ${statusClass}">`;
            html += `<h4>${statusIcon} Azure Blob Storage Test</h4>`;
            html += `<div class="test-meta">`;
            html += `<span class="duration">⏱️ ${result.duration_seconds?.toFixed(2) || 'N/A'}s</span>`;
            html += `<span class="status">Status: ${result.status}</span>`;
            html += `</div>`;
            html += `</div>`;

            html += `<div class="result-message">`;
            html += `<p><strong>☁️ Result:</strong> ${result.message}</p>`;
            html += `</div>`;

            // Sub-tests
            if (result.sub_tests) {
                html += `<div class="sub-tests-section">`;
                html += `<h5>🔍 Storage Operations:</h5>`;
                html += `<div class="sub-tests-grid">`;

                for (const [testName, testResult] of Object.entries(result.sub_tests)) {
                    const icon = testResult.success ? '✅' : '❌';
                    const itemClass = testResult.success ? 'sub-test-success' : 'sub-test-error';

                    html += `<div class="sub-test-item ${itemClass}">`;
                    html += `<div class="sub-test-header">${icon} <strong>${testName}</strong></div>`;
                    html += `<div class="sub-test-message">${testResult.message}</div>`;

                    if (testResult.remediation) {
                        html += `<div class="remediation">💡 <em>${testResult.remediation}</em></div>`;
                    }

                    html += `</div>`;
                }

                html += `</div>`;
                html += `</div>`;
            }

            if (result.remediation) {
                html += `<div class="remediation-section">`;
                html += `<h5>💡 Remediation:</h5>`;
                html += `<div class="remediation-content">${result.remediation}</div>`;
                html += `</div>`;
            }

            html += `</div>`;
            return html;
        }

        function formatCassandraResult(result) {
            const responseId = 'cassandra-' + Date.now();
            let html = `<div class="test-result-enhanced cassandra-result">`;

            // Header with status
            let statusIcon, statusClass;
            if (result.status === 'passed') {
                statusIcon = '✅';
                statusClass = 'success';
            } else if (result.status === 'skipped') {
                statusIcon = '⚠️';
                statusClass = 'warning';
            } else {
                statusIcon = '❌';
                statusClass = 'error';
            }
            html += `<div class="result-header ${statusClass}">`;
            html += `<h4>${statusIcon} Apache Cassandra Test</h4>`;
            html += `<div class="test-meta">`;
            html += `<span class="duration">⏱️ ${result.duration_seconds?.toFixed(2) || 'N/A'}s</span>`;
            html += `<span class="status">Status: ${result.status}</span>`;
            html += `</div>`;
            html += `</div>`;

            html += `<div class="result-message">`;
            html += `<p><strong>🗃️ Result:</strong> ${result.message}</p>`;
            html += `</div>`;

            // Sub-tests
            if (result.sub_tests) {
                html += `<div class="sub-tests-section">`;
                html += `<h5>🔍 Cluster Operations:</h5>`;
                html += `<div class="sub-tests-grid">`;

                for (const [testName, testResult] of Object.entries(result.sub_tests)) {
                    const icon = testResult.success ? '✅' : '❌';
                    const itemClass = testResult.success ? 'sub-test-success' : 'sub-test-error';

                    html += `<div class="sub-test-item ${itemClass}">`;
                    html += `<div class="sub-test-header">${icon} <strong>${testName}</strong></div>`;
                    html += `<div class="sub-test-message">${testResult.message}</div>`;

                    if (testResult.remediation) {
                        html += `<div class="remediation">💡 <em>${testResult.remediation}</em></div>`;
                    }

                    html += `</div>`;
                }

                html += `</div>`;
                html += `</div>`;
            }

            if (result.remediation) {
                html += `<div class="remediation-section">`;
                html += `<h5>💡 Remediation:</h5>`;
                html += `<div class="remediation-content">${result.remediation}</div>`;
                html += `</div>`;
            }

            html += `</div>`;
            return html;
        }

        function formatSSLResult(result) {
            const responseId = 'ssl-' + Date.now();
            let html = `<div class="test-result-enhanced ssl-result">`;

            // Header with status
            let statusIcon, statusClass;
            if (result.status === 'passed') {
                statusIcon = '✅';
                statusClass = 'success';
            } else if (result.status === 'skipped') {
                statusIcon = '⚠️';
                statusClass = 'warning';
            } else {
                statusIcon = '❌';
                statusClass = 'error';
            }
            html += `<div class="result-header ${statusClass}">`;
            html += `<h4>${statusIcon} SSL Certificate Test</h4>`;
            html += `<div class="test-meta">`;
            html += `<span class="duration">⏱️ ${result.duration_seconds?.toFixed(2) || 'N/A'}s</span>`;
            html += `<span class="status">Status: ${result.status}</span>`;
            html += `</div>`;
            html += `</div>`;

            html += `<div class="result-message">`;
            html += `<p><strong>🔒 Result:</strong> ${result.message}</p>`;
            html += `</div>`;

            // Sub-tests with SSL-specific details
            if (result.sub_tests) {
                html += `<div class="sub-tests-section">`;
                html += `<h5>🔍 Certificate Analysis:</h5>`;
                html += `<div class="sub-tests-grid">`;

                for (const [testName, testResult] of Object.entries(result.sub_tests)) {
                    const icon = testResult.success ? '✅' : '❌';
                    const itemClass = testResult.success ? 'sub-test-success' : 'sub-test-error';

                    html += `<div class="sub-test-item ${itemClass}">`;
                    html += `<div class="sub-test-header">${icon} <strong>${testName}</strong></div>`;
                    html += `<div class="sub-test-message">${testResult.message}</div>`;

                    // Show SSL certificate details
                    if (testName.includes('SSL Check:') && testResult.certificate_chain_analysis) {
                        const chainInfo = testResult.certificate_chain_analysis;
                        html += `<div class="certificate-analysis">`;
                        html += `<h6>📜 Certificate Chain Analysis:</h6>`;
                        html += `<div class="chain-details">`;
                        html += `<div class="chain-item"><strong>Method:</strong> ${chainInfo.retrieval_method}</div>`;
                        html += `<div class="chain-item"><strong>Certificates Found:</strong> ${chainInfo.certificates_found}</div>`;

                        if (chainInfo.certificates && chainInfo.certificates.length > 0) {
                            html += `<div class="certificate-list">`;
                            html += `<h6>🏷️ Certificate Details:</h6>`;
                            chainInfo.certificates.forEach(cert => {
                                html += `<div class="certificate-item">`;
                                html += `<div class="cert-position">${cert.position}. ${cert.type}</div>`;
                                if (cert.subject_parsed && cert.subject_parsed['Common Name']) {
                                    html += `<div class="cert-detail"><strong>Subject:</strong> ${cert.subject_parsed['Common Name']}</div>`;
                                }
                                if (cert.issuer_parsed) {
                                    const issuer = cert.issuer_parsed['Common Name'] || cert.issuer_parsed['Organization'] || 'Unknown';
                                    html += `<div class="cert-detail"><strong>Issuer:</strong> ${issuer}</div>`;
                                }
                                html += `</div>`;
                            });
                            html += `</div>`;
                        }

                        if (chainInfo.analysis) {
                            html += `<div class="chain-analysis"><strong>Analysis:</strong> ${chainInfo.analysis}</div>`;
                        }

                        if (chainInfo.troubleshooting && chainInfo.troubleshooting.length > 0) {
                            html += `<div class="troubleshooting">`;
                            html += `<h6>🔧 Troubleshooting:</h6>`;
                            chainInfo.troubleshooting.forEach(tip => {
                                html += `<div class="troubleshooting-tip">→ ${tip}</div>`;
                            });
                            html += `</div>`;
                        }

                        html += `</div>`;
                        html += `</div>`;
                    }

                    if (testResult.remediation) {
                        html += `<div class="remediation">💡 <em>${testResult.remediation}</em></div>`;
                    }

                    html += `</div>`;
                }

                html += `</div>`;
                html += `</div>`;
            }

            if (result.remediation) {
                html += `<div class="remediation-section">`;
                html += `<h5>💡 Remediation:</h5>`;
                html += `<div class="remediation-content">${result.remediation}</div>`;
                html += `</div>`;
            }

            html += `</div>`;
            return html;
        }

        function formatKubernetesPVCResult(result) {
            const responseId = 'k8s-pvc-' + Date.now();
            let html = `<div class="test-result-enhanced k8s-result">`;

            // Header with status
            let statusIcon, statusClass;
            if (result.status === 'passed') {
                statusIcon = '✅';
                statusClass = 'success';
            } else if (result.status === 'skipped') {
                statusIcon = '⚠️';
                statusClass = 'warning';
            } else {
                statusIcon = '❌';
                statusClass = 'error';
            }
            html += `<div class="result-header ${statusClass}">`;
            html += `<h4>${statusIcon} Kubernetes PVC Test</h4>`;
            html += `<div class="test-meta">`;
            html += `<span class="duration">⏱️ ${result.duration_seconds?.toFixed(2) || 'N/A'}s</span>`;
            html += `<span class="status">Status: ${result.status}</span>`;
            html += `</div>`;
            html += `</div>`;

            html += `<div class="result-message">`;
            html += `<p><strong>☸️ Result:</strong> ${result.message}</p>`;
            html += `</div>`;

            // Sub-tests
            if (result.sub_tests) {
                html += `<div class="sub-tests-section">`;
                html += `<h5>🔍 Storage Operations:</h5>`;
                html += `<div class="sub-tests-grid">`;

                for (const [testName, testResult] of Object.entries(result.sub_tests)) {
                    const icon = testResult.success ? '✅' : '❌';
                    const itemClass = testResult.success ? 'sub-test-success' : 'sub-test-error';

                    html += `<div class="sub-test-item ${itemClass}">`;
                    html += `<div class="sub-test-header">${icon} <strong>${testName}</strong></div>`;
                    html += `<div class="sub-test-message">${testResult.message}</div>`;

                    if (testResult.remediation) {
                        html += `<div class="remediation">💡 <em>${testResult.remediation}</em></div>`;
                    }

                    html += `</div>`;
                }

                html += `</div>`;
                html += `</div>`;
            }

            if (result.remediation) {
                html += `<div class="remediation-section">`;
                html += `<h5>💡 Remediation:</h5>`;
                html += `<div class="remediation-content">${result.remediation}</div>`;
                html += `</div>`;
            }

            html += `</div>`;
            return html;
        }

        function formatLlamaResult(result) {
            const responseId = 'llama-' + Date.now();
            let html = `<div class="test-result-enhanced llama-result">`;

            // Header with status
            let statusIcon, statusClass;
            if (result.status === 'passed') {
                statusIcon = '✅';
                statusClass = 'success';
            } else if (result.status === 'skipped') {
                statusIcon = '⚠️';
                statusClass = 'warning';
            } else {
                statusIcon = '❌';
                statusClass = 'error';
            }
            html += `<div class="result-header ${statusClass}">`;
            html += `<h4>${statusIcon} Llama Model Test</h4>`;
            html += `<div class="test-meta">`;
            html += `<span class="duration">⏱️ ${result.duration_seconds?.toFixed(2) || 'N/A'}s</span>`;
            html += `<span class="status">Status: ${result.status}</span>`;
            html += `</div>`;
            html += `</div>`;

            html += `<div class="result-message">`;
            html += `<p><strong>🦙 Result:</strong> ${result.message}</p>`;
            html += `</div>`;

            // Sub-tests
            if (result.sub_tests) {
                html += `<div class="sub-tests-section">`;
                html += `<h5>🔍 Model Operations:</h5>`;
                html += `<div class="sub-tests-grid">`;

                for (const [testName, testResult] of Object.entries(result.sub_tests)) {
                    const icon = testResult.success ? '✅' : '❌';
                    const itemClass = testResult.success ? 'sub-test-success' : 'sub-test-error';

                    html += `<div class="sub-test-item ${itemClass}">`;
                    html += `<div class="sub-test-header">${icon} <strong>${testName}</strong></div>`;
                    html += `<div class="sub-test-message">${testResult.message}</div>`;

                    if (testResult.remediation) {
                        html += `<div class="remediation">💡 <em>${testResult.remediation}</em></div>`;
                    }

                    html += `</div>`;
                }

                html += `</div>`;
                html += `</div>`;
            }

            if (result.remediation) {
                html += `<div class="remediation-section">`;
                html += `<h5>💡 Remediation:</h5>`;
                html += `<div class="remediation-content">${result.remediation}</div>`;
                html += `</div>`;
            }

            html += `</div>`;
            return html;
        }

        async function handleCustomEmbeddingsTest(form) {
            const resultsElement = document.getElementById('custom-embeddings-results');
            const submitButton = form.querySelector('button[type="submit"]');
            
            try {
                // Disable submit button and show loading
                submitButton.disabled = true;
                submitButton.innerHTML = 'Generating Embeddings... <span class="loading-spinner"></span>';
                
                // Clear previous results
                resultsElement.innerHTML = '';
                resultsElement.className = 'test-details';
                
                // Check if primary text is provided (required)
                if (!form.text.value.trim()) {
                    resultsElement.className = 'test-details show custom-test-results error';
                    resultsElement.innerHTML = '❌ Error: Please enter primary text for embedding generation';
                    notificationManager.warning('Missing Text', 'Please enter primary text for embedding generation');
                    return;
                }
                
                // Prepare form data
                const formData = new FormData();
                formData.append('text', form.text.value);

                if (form.batch_texts.value.trim()) {
                    formData.append('batch_texts', form.batch_texts.value);
                }

                // Send request (no file upload needed for embeddings)
                const response = await axios.post('/api/tests/embeddings/custom', formData, {
                    headers: {
                        'Content-Type': 'multipart/form-data'
                    }
                });
                
                const result = response.data;
                
                // Display results
                if (result.success) {
                    resultsElement.className = 'test-details show custom-test-results success';
                    resultsElement.innerHTML = formatEmbeddingsResult(result);
                } else {
                    resultsElement.className = 'test-details show custom-test-results error';
                    resultsElement.innerHTML = `❌ Embedding Generation Failed: ${result.message}\\n\\n${result.remediation || ''}`;
                }
                
            } catch (error) {
                resultsElement.className = 'test-details show custom-test-results error';
                const errorMessage = error.response?.data?.detail || error.message || 'Unknown error occurred';
                resultsElement.innerHTML = `❌ Error: ${errorMessage}`;
                handleApiError(error, 'Custom AI test');
            } finally {
                // Re-enable submit button
                submitButton.disabled = false;
                submitButton.innerHTML = 'Generate Embeddings';
            }
        }
        
        function formatEmbeddingsResult(result) {
            let html = `✅ Embedding Generation Successful!\\n\\n`;
            html += `Model: ${result.model}\\n`;
            html += `Processing Time: ${result.response_time_ms}ms\\n`;
            html += `Embeddings Generated: ${result.embeddings_generated}\\n`;
            html += `Embedding Dimension: ${result.embedding_dimension}\\n`;
            
            if (result.total_tokens_used) {
                html += `Tokens Used: ${result.total_tokens_used}\\n`;
            }
            
            if (result.file_provided) {
                html += `File Content: Included`;
                if (result.file_type && result.file_type !== 'none') {
                    html += ` (${result.file_type.toUpperCase()})`;
                }
                html += `\\n`;
            }
            
            if (result.is_batch_processing) {
                html += `Batch Processing: Yes (${result.batch_size} texts)\\n`;
            }
            
            // Show embedding statistics
            if (result.embedding_stats && result.embedding_stats.length > 0) {
                html += `\\n--- Embedding Statistics ---\\n`;
                result.embedding_stats.forEach((stats, index) => {
                    html += `\\nText ${index + 1}: "${stats.input_text}"\\n`;
                    html += `- Dimension: ${stats.dimension}\\n`;
                    html += `- Range: ${stats.embedding_range.min} to ${stats.embedding_range.max}\\n`;
                    html += `- Mean: ${stats.embedding_range.mean}\\n`;
                    if (stats.vector_norm) {
                        html += `- Vector Norm: ${stats.vector_norm}\\n`;
                    }
                });
            }
            
            // Show similarity analysis
            if (result.similarities && result.similarities.length > 0) {
                html += `\\n--- Similarity Analysis ---\\n`;
                result.similarities.forEach(sim => {
                    html += `\\n"${sim.text1_preview}" vs "${sim.text2_preview}"\\n`;
                    html += `Similarity: ${sim.similarity} (${sim.similarity > 0.8 ? 'Very High' : sim.similarity > 0.6 ? 'High' : sim.similarity > 0.4 ? 'Medium' : sim.similarity > 0.2 ? 'Low' : 'Very Low'})\\n`;
                });
            }
            
            return html;
        }
    </script>
</body>
</html>