<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - {{ title }}</title>
    <link rel="stylesheet" href="{{ url_for('static', path='/style.css') }}?v={{ version }}">
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script src="{{ url_for('static', path='/critical-extensions.js') }}?v={{ version }}"></script>
    <script>
        // Configure axios to send cookies with all requests
        axios.defaults.withCredentials = true;
    </script>
</head>
<body>
    <!-- Notification System -->
    <div class="notification-container" id="notificationContainer"></div>
    
    <div class="container">
        <header class="dashboard-header">
            <div>
                <h1>{{ title }}</h1>
                <div class="connection-status">
                    <span class="status-indicator" id="connectionIndicator"></span>
                    <span id="connectionStatus">Manual refresh mode</span>
                    <span class="real-time-badge">READY</span>
                </div>
            </div>
            <div class="user-info">
                <span>Welcome, <strong>{{ username }}</strong></span>
                <a href="/logout" class="logout-button">Logout</a>
            </div>
        </header>
        
        <main>
            <div class="welcome-section">
                <h2>Infrastructure Readiness Dashboard</h2>
                <p>This dashboard helps you validate your infrastructure before deploying the main application. Run tests to check connectivity to all required services.</p>
                
                <button class="run-tests-button" onclick="runAllTests()" id="runAllTestsBtn">
                    Run All Tests
                </button>
            </div>
            
            <!-- Storage Tests Section -->
            <div class="test-section">
                <h2>üíæ Storage Tests</h2>
                <div class="test-grid">
                    <div class="test-card" id="blobstorage-card">
                    <h3>Azure Blob Storage <span class="config-ref" title="Configuration: helm/airia-test-pod/values.yaml ‚Üí config.blobStorage">‚öôÔ∏è</span></h3>
                    <p>Tests authentication and file operations</p>
                    <span class="test-status ready" id="blobstorage-status">Ready to Test</span>
                    <button class="test-button" onclick="runTest('blobstorage')" id="blobstorage-btn">Run Test</button>
                    <div class="test-details" id="blobstorage-details"></div>
                </div>
                
                <div class="test-card" id="s3-card">
                    <h3>Amazon S3 Storage <span class="config-ref" title="Configuration: helm/airia-test-pod/values.yaml ‚Üí config.s3">‚öôÔ∏è</span></h3>
                    <p>Tests S3 connectivity and operations</p>
                    <span class="test-status ready" id="s3-status">Ready to Test</span>
                    <button class="test-button" onclick="runTest('s3')" id="s3-btn">Run Test</button>
                    <div class="test-details" id="s3-details"></div>
                </div>
                
                <div class="test-card" id="minio-card">
                    <h3>Minio Storage <span class="config-ref" title="Configuration: helm/airia-test-pod/values.yaml ‚Üí config.minio">‚öôÔ∏è</span></h3>
                    <p>Tests S3-compatible storage connectivity</p>
                    <span class="test-status ready" id="minio-status">Ready to Test</span>
                    <button class="test-button" onclick="runTest('minio')" id="minio-btn">Run Test</button>
                    <div class="test-details" id="minio-details"></div>
                </div>
            </div>
            </div>
            
            <!-- Database Tests Section -->
            <div class="test-section">
                <h2>üóÑÔ∏è Database Tests</h2>
                <div class="test-grid">
                    <div class="test-card" id="postgresqlv2-card">
                        <h3>PostgreSQL Database <span class="config-ref" title="Configuration: helm/airia-test-pod/values.yaml ‚Üí config.postgresql">‚öôÔ∏è</span></h3>
                        <p>Tests connection, databases, and extensions</p>
                        <span class="test-status ready" id="postgresqlv2-status">Ready to Test</span>
                        <button class="test-button" onclick="runTest('postgresqlv2')" id="postgresqlv2-btn">Run Test</button>
                        <div class="test-details" id="postgresqlv2-details"></div>
                    </div>
                    
                    <div class="test-card" id="cassandra-card">
                        <h3>Apache Cassandra <span class="config-ref" title="Configuration: helm/airia-test-pod/values.yaml ‚Üí config.cassandra">‚öôÔ∏è</span></h3>
                        <p>Tests connectivity, keyspaces, and cluster health</p>
                        <span class="test-status ready" id="cassandra-status">Ready to Test</span>
                        <button class="test-button" onclick="runTest('cassandra')" id="cassandra-btn">Run Test</button>
                        <div class="test-details" id="cassandra-details"></div>
                    </div>
                </div>
            </div>
            
            <!-- AI & ML Tests Section -->
            <div class="test-section">
                <h2>ü§ñ AI & Machine Learning Tests</h2>
                <div class="test-grid">
                    <div class="test-card" id="openai-card">
                    <h3>OpenAI-Compatible APIs <span class="config-ref" title="Configuration: helm/airia-test-pod/values.yaml ‚Üí config.openai">‚öôÔ∏è</span></h3>
                    <p>Tests Azure OpenAI and OpenAI-compatible endpoints</p>
                    <span class="test-status ready" id="openai-status">Ready to Test</span>
                    <button class="test-button" onclick="runTest('openai')" id="openai-btn">Run Test</button>
                    <div class="test-details" id="openai-details"></div>
                </div>
                
                <div class="test-card" id="llama-card">
                    <h3>Ollama API (Native) <span class="config-ref" title="Configuration: helm/airia-test-pod/values.yaml ‚Üí config.ollama">‚öôÔ∏è</span></h3>
                    <p>Tests Ollama native API and local LLM models</p>
                    <span class="test-status ready" id="llama-status">Ready to Test</span>
                    <button class="test-button" onclick="runTest('llama')" id="llama-btn">Run Test</button>
                    <div class="test-details" id="llama-details"></div>
                </div>
                
                <div class="test-card" id="docintel-card">
                    <h3>Document Intelligence <span class="config-ref" title="Configuration: helm/airia-test-pod/values.yaml ‚Üí config.documentIntelligence">‚öôÔ∏è</span></h3>
                    <p>Tests document processing API</p>
                    <span class="test-status ready" id="docintel-status">Ready to Test</span>
                    <button class="test-button" onclick="runTest('docintel')" id="docintel-btn">Run Test</button>
                    <div class="test-details" id="docintel-details"></div>
                </div>
                
                <div class="test-card" id="embeddings-card">
                    <h3>Embedding Models <span class="config-ref" title="Configuration: helm/airia-test-pod/values.yaml ‚Üí config.embeddings">‚öôÔ∏è</span></h3>
                    <p>Tests OpenAI-compatible embedding endpoints</p>
                    <span class="test-status ready" id="embeddings-status">Ready to Test</span>
                    <button class="test-button" onclick="runTest('embeddings')" id="embeddings-btn">Run Test</button>
                    <div class="test-details" id="embeddings-details"></div>
                </div>
            </div>
            </div>
            
            <!-- Infrastructure Tests Section -->
            <div class="test-section">
                <h2>üèóÔ∏è Infrastructure Tests</h2>
                <div class="test-grid">
                    <div class="test-card" id="pvc-card">
                    <h3>Kubernetes PVC <span class="config-ref" title="Configuration: helm/airia-test-pod/values.yaml ‚Üí config.kubernetes">‚öôÔ∏è</span></h3>
                    <p>Tests storage class and permissions</p>
                    <span class="test-status ready" id="pvc-status">Ready to Test</span>
                    <button class="test-button" onclick="runTest('pvc')" id="pvc-btn">Run Test</button>
                    <div class="test-details" id="pvc-details"></div>
                </div>
                
                <div class="test-card" id="ssl-card">
                    <h3>SSL Certificates <span class="config-ref" title="Configuration: helm/airia-test-pod/values.yaml ‚Üí config.ssl">‚öôÔ∏è</span></h3>
                    <p>Validates certificate chains</p>
                    <span class="test-status ready" id="ssl-status">Ready to Test</span>
                    <button class="test-button" onclick="runTest('ssl')" id="ssl-btn">Run Test</button>
                    <div class="test-details" id="ssl-details"></div>
                </div>

                <div class="test-card" id="gpu-card">
                    <h3>GPU Detection <span class="config-ref" title="Configuration: helm/airia-test-pod/values.yaml ‚Üí config.gpu">‚öôÔ∏è</span></h3>
                    <p>Detects and validates GPU availability, driver, and CUDA installation</p>
                    <span class="test-status ready" id="gpu-status">Ready to Test</span>
                    <button class="test-button" onclick="runTest('gpu')" id="gpu-btn">Run Test</button>
                    <div class="test-details" id="gpu-details"></div>
                </div>
            </div>
            </div>
            
            <!-- Custom AI Testing Section -->
            <div class="test-section">
                <h2>üéØ Custom AI Model Testing</h2>
                <p>Test your AI models with custom prompts and file content</p>
                <div class="test-grid">
                    <div class="test-card" id="custom-openai-card">
                        <h3>Custom OpenAI-Compatible Test</h3>
                        <p>Send custom prompts and files to Azure OpenAI or OpenAI-compatible APIs</p>
                        <form id="custom-openai-form" class="custom-test-form">
                            <div class="form-group">
                                <label for="openai-prompt">Your Prompt:</label>
                                <textarea id="openai-prompt" name="prompt" placeholder="Enter your custom prompt here..." rows="3" required></textarea>
                            </div>
                            <div class="form-group">
                                <label for="openai-system">System Message (optional):</label>
                                <input type="text" id="openai-system" name="system_message" placeholder="You are a helpful assistant...">
                            </div>
                            <div class="form-group">
                                <label for="openai-file">Upload File (optional):</label>
                                <input type="file" id="openai-file" name="file" accept=".txt,.md,.json,.csv,.log,.pdf,.jpg,.jpeg,.png">
                                <small>Max 25MB, supports: text files, PDF, images (JPG, PNG)</small>
                            </div>
                            <button type="submit" class="test-button">Test OpenAI</button>
                        </form>
                        <div class="test-details" id="custom-openai-results"></div>
                    </div>
                    
                    <div class="test-card" id="custom-llama-card">
                        <h3>Custom Ollama Test</h3>
                        <p>Send custom prompts and files to Ollama native API</p>
                        <form id="custom-llama-form" class="custom-test-form">
                            <div class="form-group">
                                <label for="llama-prompt">Your Prompt:</label>
                                <textarea id="llama-prompt" name="prompt" placeholder="Enter your custom prompt here..." rows="3" required></textarea>
                            </div>
                            <div class="form-group">
                                <label for="llama-system">System Message (optional):</label>
                                <input type="text" id="llama-system" name="system_message" placeholder="You are a helpful assistant...">
                            </div>
                            <div class="form-group">
                                <label for="llama-file">Upload File (optional):</label>
                                <input type="file" id="llama-file" name="file" accept=".txt,.md,.json,.csv,.log,.pdf,.jpg,.jpeg,.png">
                                <small>Max 25MB, supports: text files, PDF, images (JPG, PNG)</small>
                            </div>
                            <button type="submit" class="test-button">Test Llama</button>
                        </form>
                        <div class="test-details" id="custom-llama-results"></div>
                    </div>
                    
                    <div class="test-card" id="custom-docintel-card">
                        <h3>Custom Document Intelligence Test</h3>
                        <p>Upload documents for Azure Document Intelligence analysis</p>
                        <form id="custom-docintel-form" class="custom-test-form">
                            <div class="form-group">
                                <label for="docintel-prompt">Analysis Request (optional):</label>
                                <textarea id="docintel-prompt" name="prompt" placeholder="Describe what you want to analyze in this document..." rows="2"></textarea>
                            </div>
                            <div class="form-group">
                                <label for="docintel-file">Upload Document (required):</label>
                                <input type="file" id="docintel-file" name="file" accept=".pdf,.jpg,.jpeg,.png,.bmp,.tiff,.tif,.docx,.xlsx,.pptx" required>
                                <small>Max 25MB, supports: PDF, images, Office documents</small>
                            </div>
                            <button type="submit" class="test-button">Analyze Document</button>
                        </form>
                        <div class="test-details" id="custom-docintel-results"></div>
                    </div>
                    
                    <div class="test-card" id="custom-embeddings-card">
                        <h3>Custom Embedding Test</h3>
                        <p>Generate embeddings for custom text with similarity analysis</p>
                        <form id="custom-embeddings-form" class="custom-test-form">
                            <div class="form-group">
                                <label for="embeddings-text">Primary Text (required):</label>
                                <textarea id="embeddings-text" name="text" placeholder="Enter text to generate embeddings for..." rows="3" required></textarea>
                            </div>
                            <div class="form-group">
                                <label for="embeddings-batch">Additional Texts (optional):</label>
                                <textarea id="embeddings-batch" name="batch_texts" placeholder="Enter additional texts separated by commas for similarity comparison..." rows="2"></textarea>
                                <small>Separate multiple texts with commas for batch processing and similarity analysis</small>
                            </div>
                            <button type="submit" class="test-button">Generate Embeddings</button>
                        </form>
                        <div class="test-details" id="custom-embeddings-results"></div>
                    </div>
                </div>
            </div>
        </main>
        
        <footer>
            <p>Airia Infrastructure Test Pod <span id="version-display">Loading...</span></p>
        </footer>
    </div>
    
    <script>
        // Enhanced Notification System
        class NotificationManager {
            constructor() {
                this.container = document.getElementById('notificationContainer');
                this.notifications = new Map();
            }
            
            show(type, title, message, details = null, duration = 5000) {
                const id = Date.now().toString();
                
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.id = `notification-${id}`;
                
                const icon = this.getIcon(type);
                
                notification.innerHTML = `
                    <div class="notification-header">
                        <span class="notification-title">${icon} ${title}</span>
                        <button class="notification-close" onclick="notificationManager.remove('${id}')">√ó</button>
                    </div>
                    <div class="notification-message">${message}</div>
                    ${details ? `<div class="notification-details">${details}</div>` : ''}
                `;
                
                this.container.appendChild(notification);
                this.notifications.set(id, notification);
                
                // Auto-remove after duration (except for error notifications)
                if (type !== 'error' && duration > 0) {
                    setTimeout(() => this.remove(id), duration);
                }
                
                return id;
            }
            
            remove(id) {
                const notification = this.notifications.get(id);
                if (notification) {
                    notification.style.animation = 'slideOut 0.3s ease-out';
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                        this.notifications.delete(id);
                    }, 300);
                }
            }
            
            clear() {
                this.notifications.forEach((_, id) => this.remove(id));
            }
            
            getIcon(type) {
                const icons = {
                    success: '‚úÖ',
                    error: '‚ùå',
                    warning: '‚ö†Ô∏è',
                    info: '‚ÑπÔ∏è'
                };
                return icons[type] || '‚ÑπÔ∏è';
            }
            
            // Convenience methods
            success(title, message, details = null) {
                return this.show('success', title, message, details);
            }
            
            error(title, message, details = null) {
                return this.show('error', title, message, details, 0); // Don't auto-remove errors
            }
            
            warning(title, message, details = null) {
                return this.show('warning', title, message, details);
            }
            
            info(title, message, details = null) {
                return this.show('info', title, message, details);
            }
        }
        
        // Initialize notification manager
        const notificationManager = new NotificationManager();
        
        // Enhanced Error Handling Functions
        function handleApiError(error, context = 'Operation') {
            console.error(`${context} error:`, error);
            
            const status = error.response?.status;
            let title, message, details;
            
            // Handle different error types
            switch (status) {
                case 401:
                case 403:
                    title = 'Authentication Required';
                    message = 'Your session has expired. Please log in again.';
                    setTimeout(() => {
                        window.location.href = '/login';
                    }, 2000);
                    break;
                    
                case 404:
                    title = 'Service Not Found';
                    message = 'The requested service or endpoint could not be found.';
                    details = `URL: ${error.config?.url || 'Unknown'}`;
                    break;
                    
                case 422:
                    title = 'Validation Error';
                    message = 'The provided data is invalid or incomplete.';
                    details = error.response?.data?.detail || 'Please check your input and try again.';
                    break;
                    
                case 424:
                    title = 'Service Dependency Failed';
                    message = 'A required service is not properly configured or unavailable.';
                    details = error.response?.data?.detail || 'Check service configuration.';
                    break;
                    
                case 500:
                    title = 'Server Error';
                    message = 'An internal server error occurred. Please try again later.';
                    details = error.response?.data?.detail || error.message;
                    break;
                    
                case 503:
                    title = 'Service Unavailable';
                    message = 'The service is temporarily unavailable. Please try again later.';
                    break;
                    
                default:
                    if (error.code === 'NETWORK_ERROR' || !error.response) {
                        title = 'Network Error';
                        message = 'Unable to connect to the server. Check your connection and try again.';
                        details = 'This might be a temporary network issue.';
                    } else {
                        title = 'Unexpected Error';
                        message = error.response?.data?.detail || error.message || 'An unknown error occurred.';
                        details = `Status: ${status} | ${context}`;
                    }
            }
            
            notificationManager.error(title, message, details);
        }
        
        function showLoadingState(element, text = 'Loading...') {
            if (!element) return;
            
            const loadingOverlay = document.createElement('div');
            loadingOverlay.className = 'loading-overlay';
            loadingOverlay.innerHTML = `
                <div class="loading-spinner"></div>
                <span>${text}</span>
            `;
            
            element.style.position = 'relative';
            element.appendChild(loadingOverlay);
            return loadingOverlay;
        }
        
        function hideLoadingState(loadingOverlay) {
            if (loadingOverlay && loadingOverlay.parentNode) {
                loadingOverlay.parentNode.removeChild(loadingOverlay);
            }
        }

        // Initialize dashboard
        window.addEventListener('load', function() {
            checkTestStatus(); // Load current test status
            loadVersion(); // Load dynamic version
        });
        
        // Load version dynamically
        async function loadVersion() {
            try {
                const response = await fetch('/version');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                const data = await response.json();
                document.getElementById('version-display').textContent = 'v' + data.version;
            } catch (error) {
                // Silently fail version loading - not critical for functionality
                console.warn('Version loading failed (non-critical):', error.message);
                // FALLBACK_VERSION: This line gets updated by automated versioning
                document.getElementById('version-display').textContent = 'v1.0.196';
            }
        }
        
        // Test functions
        async function runTest(testName) {
            const statusElement = document.getElementById(`${testName}-status`);
            const buttonElement = document.getElementById(`${testName}-btn`);
            const detailsElement = document.getElementById(`${testName}-details`);
            
            // Update UI to show running
            statusElement.textContent = 'Running...';
            statusElement.className = 'test-status running';
            buttonElement.disabled = true;
            buttonElement.innerHTML = 'Running <span class="loading-spinner"></span>';
            detailsElement.classList.remove('show');
            
            try {
                // Use existing session authentication (cookies)
                const response = await axios.post(`/api/tests/${testName}`);
                const result = response.data;
                
                // Update status based on result
                const testResult = result.result || result;
                if (testResult.status === 'passed') {
                    statusElement.textContent = 'Passed';
                    statusElement.className = 'test-status passed';
                } else if (testResult.status === 'failed') {
                    statusElement.textContent = 'Failed';
                    statusElement.className = 'test-status failed';
                } else if (testResult.status === 'skipped') {
                    statusElement.textContent = 'Skipped';
                    statusElement.className = 'test-status pending';
                }
                
                // Show details
                detailsElement.innerHTML = formatTestDetails(testResult, testName);
                detailsElement.classList.add('show');
                
            } catch (error) {
                statusElement.textContent = 'Error';
                statusElement.className = 'test-status failed';
                detailsElement.innerHTML = `<strong>Error:</strong> ${error.response?.data?.detail || error.message}`;
                detailsElement.classList.add('show');
                
                // Also show a notification for the error
                handleApiError(error, `${testName} test`);
            } finally {
                buttonElement.disabled = false;
                buttonElement.innerHTML = 'Run Test';
            }
        }
        
        async function runAllTests() {
            const button = document.getElementById('runAllTestsBtn');
            button.disabled = true;
            button.innerHTML = 'Running All Tests <span class="loading-spinner"></span>';
            
            try {
                // Use existing session authentication (cookies)
                const response = await axios.post('/api/tests/run-all');
                const data = response.data;
                const results = data.results || {};
                
                // Update individual test results
                for (const [testId, result] of Object.entries(results)) {
                    const statusElement = document.getElementById(`${testId}-status`);
                    const detailsElement = document.getElementById(`${testId}-details`);
                    
                    if (statusElement) {
                        if (result.status === 'passed') {
                            statusElement.textContent = 'Passed';
                            statusElement.className = 'test-status passed';
                        } else if (result.status === 'failed') {
                            statusElement.textContent = 'Failed';
                            statusElement.className = 'test-status failed';
                        } else if (result.status === 'skipped') {
                            statusElement.textContent = 'Skipped';
                            statusElement.className = 'test-status skipped';
                        }
                        
                        if (detailsElement) {
                            detailsElement.innerHTML = formatTestDetails(result, testId);
                            detailsElement.classList.add('show');
                        }
                    }
                }
                
                // Show overall summary
                if (data.overall_status) {
                    const message = `${data.passed_count || 0} passed, ${data.failed_count || 0} failed, ${data.skipped_count || 0} skipped`;
                    const notificationType = (data.failed_count > 0) ? 'warning' : 'success';
                    notificationManager.show(notificationType, 'All Tests Completed', message);
                }
                
            } catch (error) {
                handleApiError(error, 'Running all tests');
            } finally {
                button.disabled = false;
                button.innerHTML = 'Run All Tests';
            }
        }
        
        function formatTestDetails(result, testId) {
            // Use enhanced formatting based on test type
            if (testId) {
                // Map API test IDs to formatter functions
                if (testId === 'postgresql' || testId === 'postgresqlv2') {
                    return formatPostgreSQLResult(result);
                } else if (testId === 'blob_storage' || testId === 'blobstorage') {
                    return formatBlobStorageResult(result);
                } else if (testId === 'cassandra') {
                    return formatCassandraResult(result);
                } else if (testId === 'ssl') {
                    return formatSSLResult(result);
                } else if (testId === 'kubernetes_pvc' || testId === 'pvc') {
                    return formatKubernetesPVCResult(result);
                } else if (testId === 'llama') {
                    return formatLlamaResult(result);
                } else if (testId === 'embeddings') {
                    return formatEmbeddingResult(result);
                } else if (testId === 'docintel' || testId === 'document_intelligence') {
                    return formatDocumentIntelligenceResult(result);
                } else if (testId === 'gpu') {
                    return formatGPUResult(result);
                } else if (testId === 's3') {
                    return formatS3Result(result);
                } else if (testId === 'minio') {
                    return formatMinioResult(result);
                } else if (testId === 'openai') {
                    return formatOpenAIResult(result);
                }
            }

            // Fallback to enhanced generic formatter
            const responseId = 'generic-' + Date.now();
            let html = `<div class="test-result-enhanced generic-result">`;

            // Header
            const statusIcon = result.status === 'passed' ? '‚úÖ' : '‚ùå';
            const statusClass = result.status === 'passed' ? 'success' : 'error';
            html += `<div class="result-header ${statusClass}">`;
            html += `<h4>${statusIcon} Test Result</h4>`;
            html += `<div class="test-meta">`;
            html += `<span class="duration">‚è±Ô∏è ${result.duration_seconds?.toFixed(2) || 'N/A'}s</span>`;
            html += `<span class="status">Status: ${result.status}</span>`;
            html += `</div>`;
            html += `</div>`;

            html += `<div class="result-message">`;
            html += `<p><strong>üìä Result:</strong> ${result.message}</p>`;
            html += `</div>`;

            // Sub-tests
            if (result.sub_tests) {
                html += `<div class="sub-tests-section">`;
                html += `<h5>üîç Test Details:</h5>`;
                html += `<div class="sub-tests-grid">`;

                for (const [testName, testResult] of Object.entries(result.sub_tests)) {
                    const icon = testResult.success ? '‚úÖ' : '‚ùå';
                    const itemClass = testResult.success ? 'sub-test-success' : 'sub-test-error';

                    html += `<div class="sub-test-item ${itemClass}">`;
                    html += `<div class="sub-test-header">${icon} <strong>${testName}</strong></div>`;
                    html += `<div class="sub-test-message">${testResult.message}</div>`;

                    if (testResult.remediation) {
                        html += `<div class="remediation">üí° <em>${testResult.remediation}</em></div>`;
                    }

                    html += `</div>`;
                }

                html += `</div>`;
                html += `</div>`;
            }

            // Logs
            if (result.logs && result.logs.length > 0) {
                html += `<div class="logs-section">`;
                html += `<h5>üìù Logs:</h5>`;
                html += `<div class="logs-content">`;
                result.logs.forEach(log => {
                    html += `<div class="log-entry">[${log.level}] ${log.message}</div>`;
                });
                html += `</div>`;
                html += `</div>`;
            }

            if (result.remediation) {
                html += `<div class="remediation-section">`;
                html += `<h5>üí° Remediation:</h5>`;
                html += `<div class="remediation-content">${result.remediation}</div>`;
                html += `</div>`;
            }

            html += `</div>`;
            return html;
        }
        
        // Check test status on page load
        async function checkTestStatus() {
            try {
                const response = await axios.get('/api/tests/status');
                const tests = response.data.tests || {};
                
                for (const [testName, testData] of Object.entries(tests)) {
                    const statusElement = document.getElementById(`${testName}-status`);
                    if (statusElement && testData.status) {
                        const lastRun = testData.last_run ? new Date(testData.last_run).toLocaleString() : 'Never';
                        
                        if (testData.status === 'passed') {
                            statusElement.textContent = `Last Run: Passed (${lastRun})`;
                            statusElement.className = 'test-status passed';
                        } else if (testData.status === 'failed') {
                            statusElement.textContent = `Last Run: Failed (${lastRun})`;
                            statusElement.className = 'test-status failed';
                        } else if (testData.status === 'skipped') {
                            statusElement.textContent = `Last Run: Skipped (${lastRun})`;
                            statusElement.className = 'test-status pending';
                        }
                    }
                }
            } catch (error) {
                // Don't spam console with status check errors - they happen during normal operation
                console.warn('Status check failed (will retry):', error.message);
            }
        }
        
        // Custom AI Testing Functions
        document.addEventListener('DOMContentLoaded', function() {
            // Handle OpenAI custom test form
            document.getElementById('custom-openai-form').addEventListener('submit', async function(e) {
                e.preventDefault();
                await handleCustomTest('openai', this);
            });
            
            // Handle Llama custom test form
            document.getElementById('custom-llama-form').addEventListener('submit', async function(e) {
                e.preventDefault();
                await handleCustomTest('llama', this);
            });
            
            // Handle Document Intelligence custom test form
            document.getElementById('custom-docintel-form').addEventListener('submit', async function(e) {
                e.preventDefault();
                await handleCustomDocIntelTest(this);
            });
            
            // Handle Embeddings custom test form
            document.getElementById('custom-embeddings-form').addEventListener('submit', async function(e) {
                e.preventDefault();
                await handleCustomEmbeddingsTest(this);
            });
        });
        
        async function handleCustomTest(testType, form) {
            const resultsElement = document.getElementById(`custom-${testType}-results`);
            const submitButton = form.querySelector('button[type="submit"]');

            try {
                // Validate prompt before submitting
                const promptValue = form.prompt.value.trim();
                if (promptValue.length < 3) {
                    resultsElement.className = 'test-details show custom-test-results error';
                    resultsElement.innerHTML = '‚ùå Error: Prompt too short (minimum 3 characters)';
                    notificationManager.warning('Validation Error', 'Please enter a prompt with at least 3 characters');
                    return;
                }

                // Disable submit button and show loading
                submitButton.disabled = true;
                submitButton.innerHTML = `Testing ${testType}... <span class="loading-spinner"></span>`;

                // Clear previous results
                resultsElement.innerHTML = '';
                resultsElement.className = 'test-details';

                // Prepare form data
                const formData = new FormData();
                formData.append('prompt', promptValue);
                
                if (form.system_message.value) {
                    formData.append('system_message', form.system_message.value);
                }
                
                if (form.file.files[0]) {
                    formData.append('file', form.file.files[0]);
                }
                
                // Send request
                const response = await axios.post(`/api/tests/${testType}/custom`, formData, {
                    headers: {
                        'Content-Type': 'multipart/form-data'
                    }
                });
                
                const result = response.data;
                
                // Display results
                if (result.success) {
                    resultsElement.className = 'test-details show custom-test-results success';
                    resultsElement.innerHTML = formatCustomTestResult(result);
                    notificationManager.success('Test Completed', 'Custom AI test completed successfully!');
                } else {
                    resultsElement.className = 'test-details show custom-test-results error';
                    resultsElement.innerHTML = `‚ùå Test Failed: ${result.message}\\n\\n${result.remediation || ''}`;
                    notificationManager.error('Test Failed', result.message, result.remediation);
                }

            } catch (error) {
                resultsElement.className = 'test-details show custom-test-results error';
                // Try multiple possible error message locations
                let errorMessage = 'Unknown error occurred';
                if (error.response?.data?.detail) {
                    errorMessage = error.response.data.detail;
                } else if (typeof error.response?.data === 'string') {
                    errorMessage = error.response.data;
                } else if (error.response?.data?.message) {
                    errorMessage = error.response.data.message;
                } else if (error.message) {
                    errorMessage = error.message;
                }

                resultsElement.innerHTML = `‚ùå Error: ${errorMessage}`;

                // Show notification with helpful message for common errors
                if (errorMessage.includes('too short') || errorMessage.includes('minimum')) {
                    notificationManager.error('Validation Error', errorMessage, 'Please enter a prompt with at least 3 characters');
                } else {
                    handleApiError(error, 'Custom AI test');
                }
            } finally {
                // Re-enable submit button
                submitButton.disabled = false;
                submitButton.innerHTML = `Test ${testType.charAt(0).toUpperCase() + testType.slice(1)}`;
            }
        }
        
        function formatCustomTestResult(result) {
            // Check if this is a Document Intelligence result
            if (result.model_used && result.document_info && result.content_preview !== undefined) {
                return formatDocumentIntelligenceResult(result);
            }

            // Check if this is an Embedding result
            if (result.embedding_stats || result.embeddings_generated || result.embedding_dimension) {
                return formatEmbeddingResult(result);
            }

            // Default Llama/AI model result formatting
            const responseText = result.response_text || '';
            const isLongResponse = responseText.length > 800;
            const responseId = 'response-' + Date.now();

            let html = `<div class="custom-test-success">`;
            html += `<h4>‚úÖ Test Successful!</h4>`;

            // Test details in a structured format
            html += `<div class="test-details-grid">`;
            html += `<div class="detail-item"><strong>üìä Model:</strong> ${result.model}</div>`;
            html += `<div class="detail-item"><strong>‚è±Ô∏è Response Time:</strong> ${result.response_time_ms}ms</div>`;

            if (result.tokens_used) {
                if (typeof result.tokens_used === 'object') {
                    html += `<div class="detail-item"><strong>üî¢ Tokens:</strong> ${result.tokens_used.total_tokens} (${result.tokens_used.prompt_tokens} prompt + ${result.tokens_used.completion_tokens} completion)</div>`;
                } else {
                    html += `<div class="detail-item"><strong>üî¢ Tokens:</strong> ${result.tokens_used}</div>`;
                }
            }

            if (result.file_provided) {
                let fileInfo = 'Included in analysis';
                if (result.file_type && result.file_type !== 'none') {
                    fileInfo += ` (${result.file_type.toUpperCase()})`;
                }
                html += `<div class="detail-item"><strong>üìé File:</strong> ${fileInfo}</div>`;
            }
            html += `</div>`;

            // Response section with better formatting
            html += `<div class="response-section">`;
            html += `<h5>ü§ñ Model Response:</h5>`;

            if (isLongResponse) {
                const preview = responseText.substring(0, 400);
                html += `<div class="response-preview" id="${responseId}-preview">`;
                html += `<pre>${preview}...</pre>`;
                html += `<div class="response-meta">Showing first 400 of ${responseText.length} characters</div>`;
                html += `<button type="button" class="btn btn-sm btn-outline-primary" onclick="toggleFullResponse('${responseId}')">View Full Response</button>`;
                html += `</div>`;

                html += `<div class="response-full" id="${responseId}-full" style="display: none;">`;
                html += `<pre>${responseText}</pre>`;
                html += `<button type="button" class="btn btn-sm btn-outline-secondary" onclick="toggleFullResponse('${responseId}')">Show Preview Only</button>`;
                html += `</div>`;
            } else {
                html += `<div class="response-content">`;
                html += `<pre>${responseText}</pre>`;
                html += `</div>`;
            }

            html += `</div></div>`;

            return html;
        }

        function formatEmbeddingResult(result) {
            const responseId = 'embedding-' + Date.now();
            let html = `<div class="test-result-enhanced embedding-result">`;

            // Header with status
            let statusIcon, statusClass;
            if (result.status === 'passed') {
                statusIcon = '‚úÖ';
                statusClass = 'success';
            } else if (result.status === 'skipped') {
                statusIcon = '‚ö†Ô∏è';
                statusClass = 'warning';
            } else {
                statusIcon = '‚ùå';
                statusClass = 'error';
            }

            html += `<div class="result-header ${statusClass}">`;
            html += `<h4>${statusIcon} Embedding Models Test</h4>`;
            html += `<div class="test-meta">`;
            html += `<span class="duration">‚è±Ô∏è ${result.duration_seconds?.toFixed(2) || 'N/A'}s</span>`;
            html += `<span class="status">Status: ${result.status}</span>`;
            html += `</div>`;
            html += `</div>`;

            // Main message
            html += `<div class="result-message">`;
            html += `<p><strong>üìä Result:</strong> ${result.message}</p>`;
            html += `</div>`;

            // Only show detailed results if test passed
            if (result.status === 'passed') {

            // Extract data from nested structure
            const model = result.details?.model || result.model || 'N/A';
            const embeddingDimension = result.details?.embedding_dimension || result.embedding_dimension || 'N/A';

            // Calculate embeddings generated and average processing time from sub_tests
            let embeddingsGenerated = 0;
            let totalProcessingTime = 0;
            let testCount = 0;

            if (result.sub_tests) {
                // Count embeddings from single and batch tests
                if (result.sub_tests.single_embedding?.success) {
                    embeddingsGenerated += 1;
                    totalProcessingTime += result.sub_tests.single_embedding.details?.response_time_seconds || 0;
                    testCount += 1;
                }
                if (result.sub_tests.batch_embeddings?.success) {
                    embeddingsGenerated += result.sub_tests.batch_embeddings.details?.batch_size || 0;
                    totalProcessingTime += result.sub_tests.batch_embeddings.details?.response_time_seconds || 0;
                    testCount += 1;
                }
                if (result.sub_tests.large_text_handling?.success) {
                    embeddingsGenerated += 1;
                    totalProcessingTime += result.sub_tests.large_text_handling.details?.response_time_seconds || 0;
                    testCount += 1;
                }
            }

            const avgProcessingTimeMs = testCount > 0 ? ((totalProcessingTime / testCount) * 1000).toFixed(0) : 'N/A';

            // Primary metrics section
            html += `<div class="embedding-summary">`;
            html += `<div class="embedding-header-stats">`;
            html += `<span class="stat-item"><strong>üìä Model:</strong> ${model}</span>`;
            html += `<span class="stat-item"><strong>‚è±Ô∏è Avg Processing Time:</strong> ${avgProcessingTimeMs}ms</span>`;
            html += `<span class="stat-item"><strong>üî¢ Embeddings Generated:</strong> ${embeddingsGenerated}</span>`;
            html += `<span class="stat-item"><strong>üìê Embedding Dimension:</strong> ${embeddingDimension}</span>`;
            html += `</div>`;
            html += `</div>`;

            // Display sub-test results
            if (result.sub_tests) {
                html += `<div class="embedding-details">`;
                html += `<h5>üìä Test Details</h5>`;

                // Single embedding test
                if (result.sub_tests.single_embedding?.success) {
                    const details = result.sub_tests.single_embedding.details;
                    html += `<div class="embedding-stat-item">`;
                    html += `<div class="stat-header">`;
                    html += `<strong>‚úÖ Single Embedding:</strong> "${details.input_text?.substring(0, 50)}..."`;
                    html += `</div>`;
                    html += `<div class="stat-details">`;
                    html += `<div class="stat-row">`;
                    html += `<span class="stat-label">‚è±Ô∏è Time:</span> <span class="stat-value">${(details.response_time_seconds * 1000).toFixed(0)}ms</span>`;
                    html += `<span class="stat-label">üìê Dimension:</span> <span class="stat-value">${details.dimension}</span>`;
                    html += `<span class="stat-label">üìä Range:</span> <span class="stat-value">${details.embedding_range.min.toFixed(2)} to ${details.embedding_range.max.toFixed(2)}</span>`;
                    html += `</div>`;
                    html += `</div>`;
                    html += `</div>`;
                }

                // Batch embeddings test
                if (result.sub_tests.batch_embeddings?.success) {
                    const details = result.sub_tests.batch_embeddings.details;
                    html += `<div class="embedding-stat-item">`;
                    html += `<div class="stat-header">`;
                    html += `<strong>‚úÖ Batch Processing:</strong> ${details.batch_size} texts embedded`;
                    html += `</div>`;
                    html += `<div class="stat-details">`;
                    html += `<div class="stat-row">`;
                    html += `<span class="stat-label">‚è±Ô∏è Total Time:</span> <span class="stat-value">${(details.response_time_seconds * 1000).toFixed(0)}ms</span>`;
                    html += `<span class="stat-label">‚ö° Avg/Text:</span> <span class="stat-value">${(details.avg_time_per_embedding * 1000).toFixed(0)}ms</span>`;
                    html += `<span class="stat-label">üìê Dimension:</span> <span class="stat-value">${details.embedding_dimension}</span>`;
                    html += `</div>`;
                    html += `</div>`;
                    html += `</div>`;
                }

                // Large text handling test
                if (result.sub_tests.large_text_handling?.success) {
                    const details = result.sub_tests.large_text_handling.details;
                    html += `<div class="embedding-stat-item">`;
                    html += `<div class="stat-header">`;
                    html += `<strong>‚úÖ Large Text:</strong> ${details.input_word_count} words (${details.input_text_length} chars)`;
                    html += `</div>`;
                    html += `<div class="stat-details">`;
                    html += `<div class="stat-row">`;
                    html += `<span class="stat-label">‚è±Ô∏è Time:</span> <span class="stat-value">${(details.response_time_seconds * 1000).toFixed(0)}ms</span>`;
                    html += `<span class="stat-label">üìê Dimension:</span> <span class="stat-value">${details.embedding_dimension}</span>`;
                    html += `</div>`;
                    html += `</div>`;
                    html += `</div>`;
                }

                // Similarity validation test
                if (result.sub_tests.similarity_validation?.success) {
                    const details = result.sub_tests.similarity_validation.details;
                    html += `<div class="embedding-stat-item">`;
                    html += `<div class="stat-header">`;
                    html += `<strong>‚úÖ Similarity Validation:</strong> Quality check passed`;
                    html += `</div>`;
                    html += `<div class="stat-details">`;
                    html += `<div class="stat-row">`;
                    html += `<span class="stat-label">üîó Similar Texts:</span> <span class="stat-value">${(details.similar_texts_similarity * 100).toFixed(1)}%</span>`;
                    html += `<span class="stat-label">üîÄ Different Texts:</span> <span class="stat-value">${(details.different_texts_similarity * 100).toFixed(1)}%</span>`;
                    html += `</div>`;
                    html += `</div>`;
                    html += `</div>`;
                }

                // Empty text handling test
                if (result.sub_tests.empty_text_handling?.success) {
                    html += `<div class="embedding-stat-item">`;
                    html += `<div class="stat-header">`;
                    html += `<strong>‚úÖ Empty Input Handling:</strong> API correctly rejected empty input`;
                    html += `</div>`;
                    html += `</div>`;
                }

                html += `</div>`;
            }

            // Detailed statistics section
            if (result.embedding_stats && result.embedding_stats.length > 0) {
                html += `<div class="embedding-details">`;
                html += `<h5>üìà Embedding Statistics</h5>`;

                result.embedding_stats.forEach((stat, index) => {
                    const textPreview = stat.input_text.length > 50 ? stat.input_text.substring(0, 50) + '...' : stat.input_text;
                    html += `<div class="embedding-stat-item">`;
                    html += `<div class="stat-header">`;
                    html += `<strong>Text ${index + 1}:</strong> "${textPreview}"`;
                    html += `</div>`;
                    html += `<div class="stat-details">`;
                    html += `<div class="stat-row">`;
                    html += `<span class="stat-label">üìê Dimension:</span> <span class="stat-value">${stat.dimension}</span>`;
                    html += `<span class="stat-label">üìä Range:</span> <span class="stat-value">${stat.embedding_range.min} to ${stat.embedding_range.max}</span>`;
                    html += `</div>`;
                    html += `<div class="stat-row">`;
                    html += `<span class="stat-label">üìà Mean:</span> <span class="stat-value">${stat.embedding_range.mean}</span>`;
                    if (stat.vector_norm) {
                        html += `<span class="stat-label">üî¢ Vector Norm:</span> <span class="stat-value">${stat.vector_norm}</span>`;
                    }
                    html += `</div>`;
                    html += `</div>`;
                    html += `</div>`;
                });
                html += `</div>`;
            }

            // Similarity analysis section
            if (result.similarities && result.similarities.length > 0) {
                html += `<div class="similarity-analysis">`;
                html += `<h5>üîó Similarity Analysis</h5>`;
                html += `<div class="similarity-grid">`;

                result.similarities.forEach(sim => {
                    const similarityPercentage = Math.round(sim.similarity * 100);
                    const similarityClass = sim.similarity > 0.8 ? 'high-similarity' : sim.similarity > 0.5 ? 'medium-similarity' : 'low-similarity';

                    html += `<div class="similarity-item ${similarityClass}">`;
                    html += `<div class="similarity-texts">`;
                    html += `<div class="text-preview">"${sim.text1_preview}"</div>`;
                    html += `<div class="similarity-arrow">‚Üî</div>`;
                    html += `<div class="text-preview">"${sim.text2_preview}"</div>`;
                    html += `</div>`;
                    html += `<div class="similarity-score">${similarityPercentage}% similar</div>`;
                    html += `</div>`;
                });

                html += `</div>`;
                html += `</div>`;
            }

                // Usage information
                if (result.total_tokens_used) {
                    html += `<div class="usage-info">`;
                    html += `<span class="usage-item"><strong>üéØ Tokens Used:</strong> ${result.total_tokens_used}</span>`;
                    html += `</div>`;
                }
            }

            html += `</div>`;
            return html;
        }

        function formatDocumentIntelligenceResult(result) {
            const responseId = 'docintel-response-' + Date.now();

            // Check if this is an automated test result (has sub_tests) or custom test result
            const isAutomatedTest = result.sub_tests !== undefined && result.sub_tests !== null;

            if (isAutomatedTest) {
                // Format as enhanced test result
                let html = `<div class="test-result-enhanced docintel-result">`;

                const statusIcon = result.status === 'passed' ? '‚úÖ' : result.status === 'skipped' ? '‚ö†Ô∏è' : '‚ùå';
                const statusClass = result.status === 'passed' ? 'success' : result.status === 'skipped' ? 'warning' : 'error';

                html += `<div class="result-header ${statusClass}">`;
                html += `<h4>${statusIcon} Document Intelligence Test</h4>`;
                html += `<div class="test-meta">`;
                html += `<span class="duration">‚è±Ô∏è ${result.duration_seconds?.toFixed(2) || 'N/A'}s</span>`;
                html += `<span class="status">Status: ${result.status}</span>`;
                html += `</div>`;
                html += `</div>`;

                html += `<div class="result-message">`;
                html += `<p><strong>üìÑ Result:</strong> ${result.message}</p>`;
                html += `</div>`;

                // Sub-tests
                if (result.sub_tests) {
                    html += `<div class="sub-tests-section">`;
                    html += `<h5>üîç Document Analysis Tests:</h5>`;
                    html += `<div class="sub-tests-grid">`;

                    // API Connectivity
                    if (result.sub_tests['API Connectivity']) {
                        const test = result.sub_tests['API Connectivity'];
                        const icon = test.success ? '‚úÖ' : '‚ùå';
                        html += `<div class="sub-test-item ${test.success ? 'sub-test-success' : 'sub-test-error'}">`;
                        html += `<div class="sub-test-header">${icon} <strong>API Connectivity</strong></div>`;
                        html += `<div class="sub-test-message">${test.message}</div>`;
                        if (test.endpoint) {
                            html += `<div class="sub-test-details">`;
                            html += `<span class="stat-item"><strong>üåê Endpoint:</strong> ${test.endpoint}</span>`;
                            html += `<span class="stat-item"><strong>ü§ñ Model:</strong> ${test.model}</span>`;
                            html += `<span class="stat-item"><strong>‚è±Ô∏è Response:</strong> ${test.response_time_ms?.toFixed(0)}ms</span>`;
                            html += `</div>`;
                        }
                        html += `</div>`;
                    }

                    // Document Analysis
                    if (result.sub_tests['Document Analysis (Sample)']) {
                        const test = result.sub_tests['Document Analysis (Sample)'];
                        const icon = test.success ? '‚úÖ' : '‚ùå';
                        html += `<div class="sub-test-item ${test.success ? 'sub-test-success' : 'sub-test-error'}">`;
                        html += `<div class="sub-test-header">${icon} <strong>Document Analysis</strong></div>`;
                        html += `<div class="sub-test-message">${test.message}</div>`;
                        if (test.success && test.page_count !== undefined) {
                            html += `<div class="sub-test-details">`;
                            html += `<div class="stats-row">`;
                            html += `<span class="stat-item"><strong>üìë Pages:</strong> ${test.page_count}</span>`;
                            html += `<span class="stat-item"><strong>üìù Paragraphs:</strong> ${test.paragraph_count}</span>`;
                            html += `<span class="stat-item"><strong>üìä Tables:</strong> ${test.table_count}</span>`;
                            html += `</div>`;
                            html += `<div class="stats-row">`;
                            html += `<span class="stat-item"><strong>üìè Content:</strong> ${test.content_length} chars</span>`;
                            html += `<span class="stat-item"><strong>‚è±Ô∏è Processing:</strong> ${test.processing_time_ms?.toFixed(0)}ms</span>`;
                            html += `</div>`;
                            if (test.content_preview) {
                                html += `<div class="content-preview-section">`;
                                html += `<span class="stat-label">üìÑ Content Preview:</span>`;
                                html += `<div class="preview-text">"${test.content_preview}"</div>`;
                                html += `</div>`;
                            }
                            html += `</div>`;
                        }
                        html += `</div>`;
                    }

                    // Model Information
                    if (result.sub_tests['Model Information']) {
                        const test = result.sub_tests['Model Information'];
                        const icon = test.success ? '‚úÖ' : '‚ùå';
                        html += `<div class="sub-test-item ${test.success ? 'sub-test-success' : 'sub-test-error'}">`;
                        html += `<div class="sub-test-header">${icon} <strong>Model Information</strong></div>`;
                        html += `<div class="sub-test-message">${test.message}</div>`;
                        if (test.model_id) {
                            html += `<div class="sub-test-details">`;
                            html += `<span class="stat-item"><strong>ü§ñ Model ID:</strong> ${test.model_id}</span>`;
                            html += `<span class="stat-item"><strong>üìã Type:</strong> ${test.model_type}</span>`;
                            html += `</div>`;
                        }
                        html += `</div>`;
                    }

                    html += `</div>`;
                    html += `</div>`;
                }

                html += `</div>`;
                return html;
            }

            // Original custom test formatting
            const contentPreview = result.content_preview || '';
            const isLongContent = contentPreview.length > 500;

            let html = `<div class="custom-test-success">`;
            html += `<h4>‚úÖ Document Analysis Successful!</h4>`;

            // File and processing details
            html += `<div class="test-details-grid">`;
            html += `<div class="detail-item"><strong>üìÑ File Type:</strong> ${result.file_type?.toUpperCase() || 'Unknown'}</div>`;
            html += `<div class="detail-item"><strong>ü§ñ Model:</strong> ${result.model_used}</div>`;
            html += `<div class="detail-item"><strong>‚è±Ô∏è Processing Time:</strong> ${result.processing_time_ms}ms</div>`;
            html += `<div class="detail-item"><strong>üìä Content Length:</strong> ${result.content_length} characters</div>`;
            html += `</div>`;

            // Document structure information
            if (result.document_info) {
                html += `<div class="document-structure">`;
                html += `<h5>üìã Document Structure:</h5>`;
                html += `<div class="structure-grid">`;
                html += `<div class="structure-item"><strong>üìë Pages:</strong> ${result.document_info.pages || 0}</div>`;
                html += `<div class="structure-item"><strong>üìä Tables:</strong> ${result.document_info.tables || 0}</div>`;
                html += `<div class="structure-item"><strong>üìù Paragraphs:</strong> ${result.document_info.paragraphs || 0}</div>`;
                html += `<div class="structure-item"><strong>üîë Key-Value Pairs:</strong> ${result.document_info.key_value_pairs || 0}</div>`;
                html += `</div>`;
                html += `</div>`;
            }

            // Custom prompt and response if provided
            if (result.custom_prompt) {
                html += `<div class="analysis-request">`;
                html += `<h5>üí¨ Analysis Request:</h5>`;
                html += `<div class="request-content">${result.custom_prompt}</div>`;
                html += `</div>`;

                if (result.prompt_response) {
                    html += `<div class="analysis-response">`;
                    html += `<h5>üîç Analysis Response:</h5>`;
                    html += `<div class="response-content">${result.prompt_response.replace(/\n/g, '<br>')}</div>`;
                    html += `</div>`;
                }
            }

            // Extracted content section
            if (contentPreview) {
                html += `<div class="extracted-content">`;
                html += `<h5>üìÑ Extracted Content:</h5>`;

                if (isLongContent) {
                    const preview = contentPreview.substring(0, 300);
                    html += `<div class="content-preview" id="${responseId}-preview">`;
                    html += `<pre class="content-text">${preview}...</pre>`;
                    html += `<div class="content-meta">Showing first 300 of ${contentPreview.length} characters</div>`;
                    html += `<button type="button" class="btn btn-sm btn-outline-primary" onclick="toggleDocumentContent('${responseId}')">View Full Content</button>`;
                    html += `</div>`;

                    html += `<div class="content-full" id="${responseId}-full" style="display: none;">`;
                    html += `<pre class="content-text">${contentPreview}</pre>`;
                    html += `<button type="button" class="btn btn-sm btn-outline-secondary" onclick="toggleDocumentContent('${responseId}')">Show Preview Only</button>`;
                    html += `</div>`;
                } else {
                    html += `<div class="content-display">`;
                    html += `<pre class="content-text">${contentPreview}</pre>`;
                    html += `</div>`;
                }

                html += `</div>`;
            }

            html += `</div>`;

            return html;
        }

        // Function to toggle between preview and full response
        function toggleFullResponse(responseId) {
            const preview = document.getElementById(responseId + '-preview');
            const full = document.getElementById(responseId + '-full');

            if (preview.style.display !== 'none') {
                preview.style.display = 'none';
                full.style.display = 'block';
            } else {
                preview.style.display = 'block';
                full.style.display = 'none';
            }
        }

        // Function to toggle document content for Document Intelligence results
        function toggleDocumentContent(responseId) {
            const preview = document.getElementById(responseId + '-preview');
            const full = document.getElementById(responseId + '-full');

            if (preview.style.display !== 'none') {
                preview.style.display = 'none';
                full.style.display = 'block';
            } else {
                preview.style.display = 'block';
                full.style.display = 'none';
            }
        }
        
        async function handleCustomDocIntelTest(form) {
            const resultsElement = document.getElementById('custom-docintel-results');
            const submitButton = form.querySelector('button[type="submit"]');
            
            try {
                // Disable submit button and show loading
                submitButton.disabled = true;
                submitButton.innerHTML = 'Analyzing Document... <span class="loading-spinner"></span>';
                
                // Clear previous results
                resultsElement.innerHTML = '';
                resultsElement.className = 'test-details';
                
                // Check if file is selected (required for Document Intelligence)
                if (!form.file.files[0]) {
                    resultsElement.className = 'test-details show custom-test-results error';
                    resultsElement.innerHTML = '‚ùå Error: Please select a document to analyze';
                    notificationManager.warning('Missing File', 'Please select a document file to analyze');
                    return;
                }
                
                // Prepare form data
                const formData = new FormData();
                if (form.prompt.value) {
                    formData.append('prompt', form.prompt.value);
                }
                formData.append('file', form.file.files[0]);
                
                // Send request
                const response = await axios.post('/api/tests/docintel/custom', formData, {
                    headers: {
                        'Content-Type': 'multipart/form-data'
                    }
                });
                
                const result = response.data;
                
                // Display results
                if (result.success) {
                    resultsElement.className = 'test-details show custom-test-results success';
                    resultsElement.innerHTML = formatDocumentIntelligenceResult(result);
                } else {
                    resultsElement.className = 'test-details show custom-test-results error';
                    resultsElement.innerHTML = `‚ùå Analysis Failed: ${result.message}\\n\\n${result.remediation || ''}`;
                }
                
            } catch (error) {
                resultsElement.className = 'test-details show custom-test-results error';
                const errorMessage = error.response?.data?.detail || error.message || 'Unknown error occurred';
                resultsElement.innerHTML = `‚ùå Error: ${errorMessage}`;
                handleApiError(error, 'Custom AI test');
            } finally {
                // Re-enable submit button
                submitButton.disabled = false;
                submitButton.innerHTML = 'Analyze Document';
            }
        }
        

        // Enhanced formatting functions for all test types
        function formatPostgreSQLResult(result) {
            const responseId = 'postgres-' + Date.now();
            let html = `<div class="test-result-enhanced postgresql-result">`;

            // Header with status
            let statusIcon, statusClass;
            if (result.status === 'passed') {
                statusIcon = '‚úÖ';
                statusClass = 'success';
            } else if (result.status === 'skipped') {
                statusIcon = '‚ö†Ô∏è';
                statusClass = 'warning';
            } else {
                statusIcon = '‚ùå';
                statusClass = 'error';
            }
            html += `<div class="result-header ${statusClass}">`;
            html += `<h4>${statusIcon} PostgreSQL Database Test</h4>`;
            html += `<div class="test-meta">`;
            html += `<span class="duration">‚è±Ô∏è ${result.duration_seconds?.toFixed(2) || 'N/A'}s</span>`;
            html += `<span class="status">Status: ${result.status}</span>`;
            html += `</div>`;
            html += `</div>`;

            html += `<div class="result-message">`;
            html += `<p><strong>üóÑÔ∏è Result:</strong> ${result.message}</p>`;
            html += `</div>`;

            // Database summary from details
            if (result.details) {
                html += `<div class="database-summary">`;
                html += `<h5>üìä Database Connection</h5>`;
                html += `<div class="summary-stats">`;
                if (result.details.version) {
                    html += `<span class="stat-item"><strong>üìå Version:</strong> ${result.details.version}</span>`;
                }
                if (result.details.host) {
                    html += `<span class="stat-item"><strong>üåê Host:</strong> ${result.details.host}:${result.details.port || 5432}</span>`;
                }
                if (result.details.database) {
                    html += `<span class="stat-item"><strong>üíæ Database:</strong> ${result.details.database}</span>`;
                }
                if (result.details.database_count !== undefined) {
                    html += `<span class="stat-item"><strong>üìö Total Databases:</strong> ${result.details.database_count}</span>`;
                }
                if (result.details.extension_count !== undefined) {
                    html += `<span class="stat-item"><strong>üîß Installed Extensions:</strong> ${result.details.extension_count}</span>`;
                }
                html += `</div>`;
                html += `</div>`;

                // Show databases list prominently from sub_tests
                if (result.sub_tests && result.sub_tests.databases && result.sub_tests.databases.databases) {
                    html += `<div class="databases-overview">`;
                    html += `<h5>üìö All Accessible Databases (${result.sub_tests.databases.databases.length})</h5>`;
                    html += `<div class="database-grid">`;

                    // Sort databases by size (largest first)
                    const sortedDatabases = [...result.sub_tests.databases.databases].sort((a, b) => b.size - a.size);

                    sortedDatabases.forEach(db => {
                        html += `<div class="database-card">`;
                        html += `<div class="db-name">üìÅ ${db.name}</div>`;
                        html += `<div class="db-size">${db.size_human}</div>`;
                        html += `</div>`;
                    });

                    html += `</div>`;
                    html += `</div>`;
                }

                // Show installed extensions prominently from sub_tests
                if (result.sub_tests && result.sub_tests.extensions && result.sub_tests.extensions.installed_extensions) {
                    html += `<div class="extensions-overview">`;
                    html += `<h5>üîß Installed Extensions (${result.sub_tests.extensions.installed_extensions.length})</h5>`;
                    html += `<div class="extension-grid">`;

                    result.sub_tests.extensions.installed_extensions.forEach(ext => {
                        html += `<div class="extension-badge">`;
                        html += `<span class="ext-name">${ext.name}</span>`;
                        html += `<span class="ext-version">v${ext.version}</span>`;
                        html += `</div>`;
                    });

                    html += `</div>`;
                    html += `</div>`;

                    // Critical extensions status check - loaded from external config file
                    const criticalExtensions = window.CRITICAL_POSTGRESQL_EXTENSIONS || [];

                    const installedExtNames = result.sub_tests.extensions.installed_extensions.map(ext => ext.name.toLowerCase());
                    const availableExtNames = result.sub_tests.extensions.available_extensions
                        ? result.sub_tests.extensions.available_extensions.map(ext => ext.name.toLowerCase())
                        : [];

                    html += `<div class="critical-extensions-status">`;
                    html += `<h5>üéØ Critical Extensions Status</h5>`;
                    html += `<div class="extension-status-grid">`;

                    criticalExtensions.forEach(ext => {
                        const isInstalled = installedExtNames.includes(ext.name.toLowerCase());
                        const isAvailable = availableExtNames.includes(ext.name.toLowerCase());

                        let statusIcon, statusClass, statusText;
                        if (isInstalled) {
                            statusIcon = '‚úÖ';
                            statusClass = 'ext-installed';
                            statusText = 'Installed';
                        } else if (isAvailable) {
                            statusIcon = '‚ö†Ô∏è';
                            statusClass = 'ext-available';
                            statusText = 'Available';
                        } else {
                            statusIcon = '‚ùå';
                            statusClass = 'ext-unavailable';
                            statusText = 'Not Available';
                        }

                        html += `<div class="extension-status-item ${statusClass}">`;
                        html += `<div class="ext-status-header">`;
                        html += `<span class="ext-status-icon">${statusIcon}</span>`;
                        html += `<span class="ext-status-name">${ext.displayName}</span>`;
                        html += `</div>`;
                        html += `<div class="ext-status-desc">${ext.description}</div>`;
                        html += `<div class="ext-status-badge">${statusText}</div>`;
                        html += `</div>`;
                    });

                    html += `</div>`;
                    html += `</div>`;
                }
            }

            // Sub-tests
            if (result.sub_tests) {
                html += `<div class="sub-tests-section">`;
                html += `<h5>üîç Database Operations:</h5>`;
                html += `<div class="sub-tests-grid">`;

                for (const [testName, testResult] of Object.entries(result.sub_tests)) {
                    // Skip databases and extensions - they're shown in detailed sections above
                    if (testName === 'databases' || testName === 'extensions') {
                        continue;
                    }

                    const icon = testResult.success ? '‚úÖ' : '‚ùå';
                    const itemClass = testResult.success ? 'sub-test-success' : 'sub-test-error';

                    html += `<div class="sub-test-item ${itemClass}">`;
                    html += `<div class="sub-test-header">${icon} <strong>${testName}</strong></div>`;
                    html += `<div class="sub-test-message">${testResult.message}</div>`;

                    if (testResult.remediation) {
                        html += `<div class="remediation">üí° <em>${testResult.remediation}</em></div>`;
                    }

                    html += `</div>`;
                }

                html += `</div>`;
                html += `</div>`;
            }

            // Remediation section
            if (result.remediation) {
                html += `<div class="remediation-section">`;
                html += `<h5>üí° Remediation:</h5>`;
                html += `<div class="remediation-content">${result.remediation}</div>`;
                html += `</div>`;
            }

            html += `</div>`;
            return html;
        }

        function formatBlobStorageResult(result) {
            const responseId = 'blob-' + Date.now();
            let html = `<div class="test-result-enhanced blob-result">`;

            // Header with status
            let statusIcon, statusClass;
            if (result.status === 'passed') {
                statusIcon = '‚úÖ';
                statusClass = 'success';
            } else if (result.status === 'skipped') {
                statusIcon = '‚ö†Ô∏è';
                statusClass = 'warning';
            } else {
                statusIcon = '‚ùå';
                statusClass = 'error';
            }
            html += `<div class="result-header ${statusClass}">`;
            html += `<h4>${statusIcon} Azure Blob Storage Test</h4>`;
            html += `<div class="test-meta">`;
            html += `<span class="duration">‚è±Ô∏è ${result.duration_seconds?.toFixed(2) || 'N/A'}s</span>`;
            html += `<span class="status">Status: ${result.status}</span>`;
            html += `</div>`;
            html += `</div>`;

            html += `<div class="result-message">`;
            html += `<p><strong>‚òÅÔ∏è Result:</strong> ${result.message}</p>`;
            html += `</div>`;

            // Storage summary from details
            if (result.details) {
                html += `<div class="storage-summary">`;
                html += `<h5>‚òÅÔ∏è Storage Account Information</h5>`;
                html += `<div class="summary-stats">`;
                if (result.details.account_name) {
                    html += `<span class="stat-item"><strong>üì¶ Account:</strong> ${result.details.account_name}</span>`;
                }
                if (result.details.container_name) {
                    html += `<span class="stat-item"><strong>üìÅ Container:</strong> ${result.details.container_name}</span>`;
                }
                if (result.details.upload_speed_mbps !== undefined) {
                    html += `<span class="stat-item"><strong>‚¨ÜÔ∏è Upload:</strong> ${result.details.upload_speed_mbps.toFixed(3)} Mbps</span>`;
                }
                if (result.details.download_speed_mbps !== undefined) {
                    html += `<span class="stat-item"><strong>‚¨áÔ∏è Download:</strong> ${result.details.download_speed_mbps.toFixed(3)} Mbps</span>`;
                }
                if (result.details.test_blob_size !== undefined) {
                    html += `<span class="stat-item"><strong>üìè Test Blob:</strong> ${result.details.test_blob_size} bytes</span>`;
                }
                html += `</div>`;
                html += `</div>`;
            }

            // Sub-tests
            if (result.sub_tests) {
                html += `<div class="sub-tests-section">`;
                html += `<h5>üîç Storage Operations:</h5>`;
                html += `<div class="sub-tests-grid">`;

                for (const [testName, testResult] of Object.entries(result.sub_tests)) {
                    const icon = testResult.success ? '‚úÖ' : '‚ùå';
                    const itemClass = testResult.success ? 'sub-test-success' : 'sub-test-error';

                    html += `<div class="sub-test-item ${itemClass}">`;
                    html += `<div class="sub-test-header">${icon} <strong>${testName}</strong></div>`;
                    html += `<div class="sub-test-message">${testResult.message}</div>`;

                    if (testResult.remediation) {
                        html += `<div class="remediation">üí° <em>${testResult.remediation}</em></div>`;
                    }

                    html += `</div>`;
                }

                html += `</div>`;
                html += `</div>`;
            }

            if (result.remediation) {
                html += `<div class="remediation-section">`;
                html += `<h5>üí° Remediation:</h5>`;
                html += `<div class="remediation-content">${result.remediation}</div>`;
                html += `</div>`;
            }

            html += `</div>`;
            return html;
        }

        function formatCassandraResult(result) {
            const responseId = 'cassandra-' + Date.now();
            let html = `<div class="test-result-enhanced cassandra-result">`;

            // Header with status
            let statusIcon, statusClass;
            if (result.status === 'passed') {
                statusIcon = '‚úÖ';
                statusClass = 'success';
            } else if (result.status === 'skipped') {
                statusIcon = '‚ö†Ô∏è';
                statusClass = 'warning';
            } else {
                statusIcon = '‚ùå';
                statusClass = 'error';
            }
            html += `<div class="result-header ${statusClass}">`;
            html += `<h4>${statusIcon} Apache Cassandra Test</h4>`;
            html += `<div class="test-meta">`;
            html += `<span class="duration">‚è±Ô∏è ${result.duration_seconds?.toFixed(2) || 'N/A'}s</span>`;
            html += `<span class="status">Status: ${result.status}</span>`;
            html += `</div>`;
            html += `</div>`;

            html += `<div class="result-message">`;
            html += `<p><strong>üóÉÔ∏è Result:</strong> ${result.message}</p>`;
            html += `</div>`;

            // Cluster summary from details
            if (result.details) {
                html += `<div class="cluster-summary">`;
                html += `<h5>‚òÅÔ∏è Cluster Information</h5>`;
                html += `<div class="summary-stats">`;
                if (result.details.cluster_name) {
                    html += `<span class="stat-item"><strong>üè∑Ô∏è Cluster:</strong> ${result.details.cluster_name}</span>`;
                }
                if (result.details.hosts) {
                    html += `<span class="stat-item"><strong>üåê Hosts:</strong> ${result.details.hosts}</span>`;
                }
                if (result.details.datacenter) {
                    html += `<span class="stat-item"><strong>üè¢ Datacenter:</strong> ${result.details.datacenter}</span>`;
                }
                if (result.details.nodes !== undefined) {
                    html += `<span class="stat-item"><strong>üñ•Ô∏è Nodes:</strong> ${result.details.nodes}</span>`;
                }
                if (result.details.keyspace_count !== undefined) {
                    html += `<span class="stat-item"><strong>üîë Keyspaces:</strong> ${result.details.keyspace_count}</span>`;
                }
                html += `</div>`;
                html += `</div>`;
            }

            // Sub-tests
            if (result.sub_tests) {
                html += `<div class="sub-tests-section">`;
                html += `<h5>üîç Cluster Operations:</h5>`;
                html += `<div class="sub-tests-grid">`;

                for (const [testName, testResult] of Object.entries(result.sub_tests)) {
                    const icon = testResult.success ? '‚úÖ' : '‚ùå';
                    const itemClass = testResult.success ? 'sub-test-success' : 'sub-test-error';

                    html += `<div class="sub-test-item ${itemClass}">`;
                    html += `<div class="sub-test-header">${icon} <strong>${testName}</strong></div>`;
                    html += `<div class="sub-test-message">${testResult.message}</div>`;

                    if (testResult.remediation) {
                        html += `<div class="remediation">üí° <em>${testResult.remediation}</em></div>`;
                    }

                    html += `</div>`;
                }

                html += `</div>`;
                html += `</div>`;
            }

            if (result.remediation) {
                html += `<div class="remediation-section">`;
                html += `<h5>üí° Remediation:</h5>`;
                html += `<div class="remediation-content">${result.remediation}</div>`;
                html += `</div>`;
            }

            html += `</div>`;
            return html;
        }

        function formatSSLResult(result) {
            const responseId = 'ssl-' + Date.now();
            let html = `<div class="test-result-enhanced ssl-result">`;

            // Header with status
            let statusIcon, statusClass;
            if (result.status === 'passed') {
                statusIcon = '‚úÖ';
                statusClass = 'success';
            } else if (result.status === 'skipped') {
                statusIcon = '‚ö†Ô∏è';
                statusClass = 'warning';
            } else {
                statusIcon = '‚ùå';
                statusClass = 'error';
            }
            html += `<div class="result-header ${statusClass}">`;
            html += `<h4>${statusIcon} SSL Certificate Test</h4>`;
            html += `<div class="test-meta">`;
            html += `<span class="duration">‚è±Ô∏è ${result.duration_seconds?.toFixed(2) || 'N/A'}s</span>`;
            html += `<span class="status">Status: ${result.status}</span>`;
            html += `</div>`;
            html += `</div>`;

            html += `<div class="result-message">`;
            html += `<p><strong>üîí Result:</strong> ${result.message}</p>`;
            html += `</div>`;

            // Sub-tests with SSL-specific details
            if (result.sub_tests) {
                html += `<div class="sub-tests-section">`;
                html += `<h5>üîç Certificate Analysis:</h5>`;
                html += `<div class="sub-tests-grid">`;

                for (const [testName, testResult] of Object.entries(result.sub_tests)) {
                    const icon = testResult.success ? '‚úÖ' : '‚ùå';
                    const itemClass = testResult.success ? 'sub-test-success' : 'sub-test-error';

                    html += `<div class="sub-test-item ${itemClass}">`;
                    html += `<div class="sub-test-header">${icon} <strong>${testName}</strong></div>`;
                    html += `<div class="sub-test-message">${testResult.message}</div>`;

                    // Show certificate summary
                    if (testName.includes('SSL Check:') && testResult.certificate_info) {
                        const certInfo = testResult.certificate_info;
                        html += `<div class="certificate-summary">`;
                        html += `<div class="cert-stats">`;
                        if (certInfo.subject) {
                            html += `<span class="stat-item"><strong>üìú Subject:</strong> ${certInfo.subject}</span>`;
                        }
                        if (certInfo.issuer) {
                            html += `<span class="stat-item"><strong>‚úçÔ∏è Issuer:</strong> ${certInfo.issuer}</span>`;
                        }
                        if (certInfo.days_until_expiry !== undefined) {
                            const expiryClass = certInfo.days_until_expiry < 30 ? 'expiry-warning' : 'expiry-ok';
                            html += `<span class="stat-item ${expiryClass}"><strong>‚è∞ Expires in:</strong> ${certInfo.days_until_expiry} days</span>`;
                        }
                        if (certInfo.chain_length) {
                            html += `<span class="stat-item"><strong>üîó Chain Length:</strong> ${certInfo.chain_length} certificates</span>`;
                        }
                        html += `</div>`;

                        // Show TLS version from checks
                        if (testResult.checks && testResult.checks.connection && testResult.checks.connection.version) {
                            html += `<div class="tls-info">`;
                            html += `<span class="stat-item"><strong>üîê TLS Version:</strong> ${testResult.checks.connection.version}</span>`;
                            if (testResult.checks.connection.cipher && testResult.checks.connection.cipher[0]) {
                                html += `<span class="stat-item"><strong>üîë Cipher:</strong> ${testResult.checks.connection.cipher[0]}</span>`;
                            }
                            html += `</div>`;
                        }
                        html += `</div>`;
                    }

                    // Show SSL certificate details
                    if (testName.includes('SSL Check:') && testResult.certificate_chain_analysis) {
                        const chainInfo = testResult.certificate_chain_analysis;
                        html += `<div class="certificate-analysis">`;
                        html += `<h6>üìú Certificate Chain Analysis:</h6>`;
                        html += `<div class="chain-details">`;
                        html += `<div class="chain-item"><strong>Method:</strong> ${chainInfo.retrieval_method}</div>`;
                        html += `<div class="chain-item"><strong>Certificates Found:</strong> ${chainInfo.certificates_found}</div>`;

                        if (chainInfo.certificates && chainInfo.certificates.length > 0) {
                            html += `<div class="certificate-list">`;
                            html += `<h6>üè∑Ô∏è Certificate Details:</h6>`;
                            chainInfo.certificates.forEach(cert => {
                                html += `<div class="certificate-item">`;
                                html += `<div class="cert-position">${cert.position}. ${cert.type}</div>`;
                                if (cert.subject_parsed && cert.subject_parsed['Common Name']) {
                                    html += `<div class="cert-detail"><strong>Subject:</strong> ${cert.subject_parsed['Common Name']}</div>`;
                                }
                                if (cert.issuer_parsed) {
                                    const issuer = cert.issuer_parsed['Common Name'] || cert.issuer_parsed['Organization'] || 'Unknown';
                                    html += `<div class="cert-detail"><strong>Issuer:</strong> ${issuer}</div>`;
                                }
                                html += `</div>`;
                            });
                            html += `</div>`;
                        }

                        if (chainInfo.analysis) {
                            html += `<div class="chain-analysis"><strong>Analysis:</strong> ${chainInfo.analysis}</div>`;
                        }

                        if (chainInfo.troubleshooting && chainInfo.troubleshooting.length > 0) {
                            html += `<div class="troubleshooting">`;
                            html += `<h6>üîß Troubleshooting:</h6>`;
                            chainInfo.troubleshooting.forEach(tip => {
                                html += `<div class="troubleshooting-tip">‚Üí ${tip}</div>`;
                            });
                            html += `</div>`;
                        }

                        html += `</div>`;
                        html += `</div>`;
                    }

                    if (testResult.remediation) {
                        html += `<div class="remediation">üí° <em>${testResult.remediation}</em></div>`;
                    }

                    html += `</div>`;
                }

                html += `</div>`;
                html += `</div>`;
            }

            if (result.remediation) {
                html += `<div class="remediation-section">`;
                html += `<h5>üí° Remediation:</h5>`;
                html += `<div class="remediation-content">${result.remediation}</div>`;
                html += `</div>`;
            }

            html += `</div>`;
            return html;
        }

        function formatKubernetesPVCResult(result) {
            const responseId = 'k8s-pvc-' + Date.now();
            let html = `<div class="test-result-enhanced k8s-result">`;

            // Header with status
            let statusIcon, statusClass;
            if (result.status === 'passed') {
                statusIcon = '‚úÖ';
                statusClass = 'success';
            } else if (result.status === 'skipped') {
                statusIcon = '‚ö†Ô∏è';
                statusClass = 'warning';
            } else {
                statusIcon = '‚ùå';
                statusClass = 'error';
            }
            html += `<div class="result-header ${statusClass}">`;
            html += `<h4>${statusIcon} Kubernetes PVC Test</h4>`;
            html += `<div class="test-meta">`;
            html += `<span class="duration">‚è±Ô∏è ${result.duration_seconds?.toFixed(2) || 'N/A'}s</span>`;
            html += `<span class="status">Status: ${result.status}</span>`;
            html += `</div>`;
            html += `</div>`;

            html += `<div class="result-message">`;
            html += `<p><strong>‚ò∏Ô∏è Result:</strong> ${result.message}</p>`;
            html += `</div>`;

            // Storage summary from details
            if (result.details) {
                html += `<div class="storage-summary">`;
                html += `<h5>‚ò∏Ô∏è Kubernetes Storage Information</h5>`;
                html += `<div class="summary-stats">`;
                if (result.details.namespace) {
                    html += `<span class="stat-item"><strong>üìÅ Namespace:</strong> ${result.details.namespace}</span>`;
                }
                if (result.details.storage_class) {
                    html += `<span class="stat-item"><strong>üíæ Storage Class:</strong> ${result.details.storage_class}</span>`;
                }
                if (result.details.security_note) {
                    html += `<span class="stat-item"><strong>üîí Security:</strong> ${result.details.security_note}</span>`;
                }
                html += `</div>`;
                html += `</div>`;
            }

            // Sub-tests
            if (result.sub_tests) {
                html += `<div class="sub-tests-section">`;
                html += `<h5>üîç Storage Operations:</h5>`;
                html += `<div class="sub-tests-grid">`;

                for (const [testName, testResult] of Object.entries(result.sub_tests)) {
                    const icon = testResult.success ? '‚úÖ' : '‚ùå';
                    const itemClass = testResult.success ? 'sub-test-success' : 'sub-test-error';

                    html += `<div class="sub-test-item ${itemClass}">`;
                    html += `<div class="sub-test-header">${icon} <strong>${testName}</strong></div>`;
                    html += `<div class="sub-test-message">${testResult.message}</div>`;

                    if (testResult.remediation) {
                        html += `<div class="remediation">üí° <em>${testResult.remediation}</em></div>`;
                    }

                    html += `</div>`;
                }

                html += `</div>`;
                html += `</div>`;
            }

            if (result.remediation) {
                html += `<div class="remediation-section">`;
                html += `<h5>üí° Remediation:</h5>`;
                html += `<div class="remediation-content">${result.remediation}</div>`;
                html += `</div>`;
            }

            html += `</div>`;
            return html;
        }

        function formatGPUResult(result) {
            const responseId = 'gpu-' + Date.now();
            let html = `<div class="test-result-enhanced gpu-result">`;

            // Header with status
            let statusIcon, statusClass;
            if (result.status === 'passed') {
                statusIcon = '‚úÖ';
                statusClass = 'success';
            } else if (result.status === 'skipped') {
                statusIcon = '‚ö†Ô∏è';
                statusClass = 'warning';
            } else {
                statusIcon = '‚ùå';
                statusClass = 'error';
            }

            html += `<div class="result-header ${statusClass}">`;
            html += `<h4>${statusIcon} GPU Detection Test</h4>`;
            html += `<div class="test-meta">`;
            html += `<span class="duration">‚è±Ô∏è ${result.duration_seconds?.toFixed(3) || 'N/A'}s</span>`;
            html += `<span class="status">Status: ${result.status}</span>`;
            html += `</div>`;
            html += `</div>`;

            html += `<div class="result-message">`;
            html += `<p><strong>üéÆ Result:</strong> ${result.message}</p>`;
            html += `</div>`;

            // GPU Details if detected
            if (result.details?.gpu_detected) {
                html += `<div class="gpu-details">`;
                html += `<h5>üíæ GPU Information</h5>`;
                html += `<div class="gpu-stats">`;
                html += `<span class="stat-item"><strong>üéÆ GPUs Detected:</strong> ${result.details.gpu_count}</span>`;

                if (result.details.gpu_info) {
                    result.details.gpu_info.forEach((gpu, index) => {
                        html += `<div class="gpu-card">`;
                        html += `<h6>GPU ${index}: ${gpu.name || 'Unknown'}</h6>`;
                        html += `<div class="gpu-card-details">`;
                        if (gpu.memory_total) {
                            html += `<span class="stat-item"><strong>üíæ Memory:</strong> ${gpu.memory_total}</span>`;
                        }
                        if (gpu.driver_version) {
                            html += `<span class="stat-item"><strong>üîß Driver:</strong> ${gpu.driver_version}</span>`;
                        }
                        if (gpu.cuda_version) {
                            html += `<span class="stat-item"><strong>‚ö° CUDA:</strong> ${gpu.cuda_version}</span>`;
                        }
                        html += `</div>`;
                        html += `</div>`;
                    });
                }
                html += `</div>`;
                html += `</div>`;
            }

            // Sub-tests
            if (result.sub_tests) {
                html += `<div class="sub-tests-section">`;
                html += `<h5>üîç Detection Steps:</h5>`;
                html += `<div class="sub-tests-grid">`;

                for (const [testName, testResult] of Object.entries(result.sub_tests)) {
                    const icon = testResult.success ? '‚úÖ' : '‚ùå';
                    const itemClass = testResult.success ? 'sub-test-success' : 'sub-test-error';

                    html += `<div class="sub-test-item ${itemClass}">`;
                    html += `<div class="sub-test-header">${icon} <strong>${testName}</strong></div>`;
                    html += `<div class="sub-test-message">${testResult.message}</div>`;

                    if (testResult.remediation) {
                        html += `<div class="remediation">üí° <em>${testResult.remediation}</em></div>`;
                    }

                    html += `</div>`;
                }

                html += `</div>`;
                html += `</div>`;
            }

            if (result.remediation) {
                html += `<div class="remediation-section">`;
                html += `<h5>üí° Remediation:</h5>`;
                html += `<div class="remediation-content">${result.remediation}</div>`;
                html += `</div>`;
            }

            html += `</div>`;
            return html;
        }

        function formatLlamaResult(result) {
            const responseId = 'llama-' + Date.now();
            let html = `<div class="test-result-enhanced llama-result">`;

            // Header with status
            let statusIcon, statusClass;
            if (result.status === 'passed') {
                statusIcon = '‚úÖ';
                statusClass = 'success';
            } else if (result.status === 'skipped') {
                statusIcon = '‚ö†Ô∏è';
                statusClass = 'warning';
            } else {
                statusIcon = '‚ùå';
                statusClass = 'error';
            }
            html += `<div class="result-header ${statusClass}">`;
            html += `<h4>${statusIcon} Llama Model Test</h4>`;
            html += `<div class="test-meta">`;
            html += `<span class="duration">‚è±Ô∏è ${result.duration_seconds?.toFixed(2) || 'N/A'}s</span>`;
            html += `<span class="status">Status: ${result.status}</span>`;
            html += `</div>`;
            html += `</div>`;

            html += `<div class="result-message">`;
            html += `<p><strong>ü¶ô Result:</strong> ${result.message}</p>`;
            html += `</div>`;

            // Sub-tests with enhanced display
            if (result.sub_tests) {
                html += `<div class="sub-tests-section">`;
                html += `<h5>üîç Model Tests:</h5>`;
                html += `<div class="sub-tests-grid">`;

                // API Connection Test
                if (result.sub_tests['API Connection']) {
                    const testResult = result.sub_tests['API Connection'];
                    const icon = testResult.success ? '‚úÖ' : '‚ùå';
                    const itemClass = testResult.success ? 'sub-test-success' : 'sub-test-error';

                    html += `<div class="sub-test-item ${itemClass}">`;
                    html += `<div class="sub-test-header">${icon} <strong>API Connection</strong></div>`;
                    html += `<div class="sub-test-message">${testResult.message}</div>`;

                    if (testResult.version) {
                        html += `<div class="sub-test-details">`;
                        html += `<span class="stat-item"><strong>üîñ Version:</strong> ${testResult.version}</span>`;
                        html += `</div>`;
                    }

                    html += `</div>`;
                }

                // List Models Test
                if (result.sub_tests['List Models']) {
                    const testResult = result.sub_tests['List Models'];
                    const icon = testResult.success ? '‚úÖ' : '‚ùå';
                    const itemClass = testResult.success ? 'sub-test-success' : 'sub-test-error';

                    html += `<div class="sub-test-item ${itemClass}">`;
                    html += `<div class="sub-test-header">${icon} <strong>List Models</strong></div>`;
                    html += `<div class="sub-test-message">${testResult.message}</div>`;

                    if (testResult.models && testResult.models.length > 0) {
                        html += `<div class="sub-test-details">`;
                        html += `<span class="stat-label">üìã Available Models (${testResult.models.length}):</span><br/>`;
                        html += `<div class="models-list">`;
                        testResult.models.forEach(model => {
                            const isTarget = testResult.target_model && model.includes(testResult.target_model);
                            const badgeClass = isTarget ? 'model-badge-target' : 'model-badge';
                            const targetIcon = isTarget ? ' ‚≠ê' : '';
                            html += `<span class="${badgeClass}">${model}${targetIcon}</span>`;
                        });
                        html += `</div>`;
                        if (testResult.target_model) {
                            const found = testResult.model_found ? '‚úÖ Found' : '‚ö†Ô∏è Not found';
                            html += `<div class="stats-row" style="margin-top: 0.5rem;">`;
                            html += `<span class="stat-item"><strong>üéØ Target Model:</strong> ${testResult.target_model} (${found})</span>`;
                            html += `</div>`;
                        }
                        html += `</div>`;
                    }

                    html += `</div>`;
                }

                // Text Generation Test
                if (result.sub_tests['Text Generation']) {
                    const testResult = result.sub_tests['Text Generation'];
                    const icon = testResult.success ? '‚úÖ' : '‚ùå';
                    const itemClass = testResult.success ? 'sub-test-success' : 'sub-test-error';

                    html += `<div class="sub-test-item ${itemClass}">`;
                    html += `<div class="sub-test-header">${icon} <strong>Text Generation</strong></div>`;
                    html += `<div class="sub-test-message">${testResult.message}</div>`;

                    if (testResult.input_prompt) {
                        html += `<div class="sub-test-details">`;
                        html += `<div class="prompt-section">`;
                        html += `<span class="stat-label">üí¨ Prompt:</span>`;
                        html += `<div class="prompt-text">"${testResult.input_prompt}"</div>`;
                        html += `</div>`;

                        if (testResult.response_preview || testResult.response_full) {
                            const response = testResult.response_full || testResult.response_preview;
                            const isLong = response.length > 200;
                            const displayResponse = isLong ? response.substring(0, 200) + '...' : response;

                            html += `<div class="response-section">`;
                            html += `<span class="stat-label">üí° Response:</span>`;
                            html += `<div class="response-text">"${displayResponse}"</div>`;
                            html += `</div>`;
                        }

                        html += `<div class="stats-row">`;
                        if (testResult.duration_seconds) {
                            html += `<span class="stat-item"><strong>‚è±Ô∏è Time:</strong> ${(testResult.duration_seconds * 1000).toFixed(0)}ms</span>`;
                        }
                        if (testResult.response_length) {
                            html += `<span class="stat-item"><strong>üìè Length:</strong> ${testResult.response_length} chars</span>`;
                        }
                        html += `</div>`;
                        html += `</div>`;
                    }

                    html += `</div>`;
                }

                // Llama-style Prompt Test
                if (result.sub_tests['Llama-style Prompt']) {
                    const testResult = result.sub_tests['Llama-style Prompt'];
                    const icon = testResult.success ? '‚úÖ' : '‚ùå';
                    const itemClass = testResult.success ? 'sub-test-success' : 'sub-test-error';

                    html += `<div class="sub-test-item ${itemClass}">`;
                    html += `<div class="sub-test-header">${icon} <strong>Llama-style Prompt</strong></div>`;
                    html += `<div class="sub-test-message">${testResult.message}</div>`;

                    if (testResult.input_prompt) {
                        html += `<div class="sub-test-details">`;
                        html += `<div class="prompt-section">`;
                        html += `<span class="stat-label">üí¨ Prompt:</span>`;
                        html += `<div class="prompt-text">"${testResult.input_prompt}"</div>`;
                        html += `</div>`;

                        if (testResult.response_preview || testResult.response_full) {
                            const response = testResult.response_full || testResult.response_preview;
                            const isLong = response.length > 200;
                            const displayResponse = isLong ? response.substring(0, 200) + '...' : response;

                            html += `<div class="response-section">`;
                            html += `<span class="stat-label">üí° Response:</span>`;
                            html += `<div class="response-text">"${displayResponse}"</div>`;
                            html += `</div>`;
                        }

                        html += `<div class="stats-row">`;
                        if (testResult.duration_seconds) {
                            html += `<span class="stat-item"><strong>‚è±Ô∏è Time:</strong> ${(testResult.duration_seconds * 1000).toFixed(0)}ms</span>`;
                        }
                        if (testResult.response_length) {
                            html += `<span class="stat-item"><strong>üìè Length:</strong> ${testResult.response_length} chars</span>`;
                        }
                        if (testResult.mentions_llama !== undefined) {
                            const llamaMention = testResult.mentions_llama ? '‚úÖ Yes' : '‚ùå No';
                            html += `<span class="stat-item"><strong>ü¶ô Mentions Llama:</strong> ${llamaMention}</span>`;
                        }
                        html += `</div>`;
                        html += `</div>`;
                    }

                    html += `</div>`;
                }

                // Chat Completion Test
                if (result.sub_tests['Chat Completion']) {
                    const testResult = result.sub_tests['Chat Completion'];
                    const icon = testResult.success ? '‚úÖ' : '‚ùå';
                    const itemClass = testResult.success ? 'sub-test-success' : 'sub-test-error';

                    html += `<div class="sub-test-item ${itemClass}">`;
                    html += `<div class="sub-test-header">${icon} <strong>Chat Completion</strong></div>`;
                    html += `<div class="sub-test-message">${testResult.message}</div>`;

                    if (testResult.user_message) {
                        html += `<div class="sub-test-details">`;
                        html += `<div class="prompt-section">`;
                        html += `<span class="stat-label">üí¨ Message:</span>`;
                        html += `<div class="prompt-text">"${testResult.user_message}"</div>`;
                        html += `</div>`;

                        if (testResult.response || testResult.response_full) {
                            const response = testResult.response_full || testResult.response;
                            const isLong = response.length > 200;
                            const displayResponse = isLong ? response.substring(0, 200) + '...' : response;

                            html += `<div class="response-section">`;
                            html += `<span class="stat-label">üí° Response:</span>`;
                            html += `<div class="response-text">"${displayResponse}"</div>`;
                            html += `</div>`;
                        }

                        html += `<div class="stats-row">`;
                        if (testResult.duration_seconds) {
                            html += `<span class="stat-item"><strong>‚è±Ô∏è Time:</strong> ${(testResult.duration_seconds * 1000).toFixed(0)}ms</span>`;
                        }
                        if (testResult.response_length) {
                            html += `<span class="stat-item"><strong>üìè Length:</strong> ${testResult.response_length} chars</span>`;
                        }
                        if (testResult.eval_count) {
                            html += `<span class="stat-item"><strong>üéØ Tokens:</strong> ${testResult.eval_count}</span>`;
                        }
                        html += `</div>`;
                        html += `</div>`;
                    }

                    html += `</div>`;
                }

                html += `</div>`;
                html += `</div>`;
            }

            if (result.remediation) {
                html += `<div class="remediation-section">`;
                html += `<h5>üí° Remediation:</h5>`;
                html += `<div class="remediation-content">${result.remediation}</div>`;
                html += `</div>`;
            }

            html += `</div>`;
            return html;
        }

        async function handleCustomEmbeddingsTest(form) {
            const resultsElement = document.getElementById('custom-embeddings-results');
            const submitButton = form.querySelector('button[type="submit"]');
            
            try {
                // Disable submit button and show loading
                submitButton.disabled = true;
                submitButton.innerHTML = 'Generating Embeddings... <span class="loading-spinner"></span>';
                
                // Clear previous results
                resultsElement.innerHTML = '';
                resultsElement.className = 'test-details';
                
                // Check if primary text is provided (required)
                if (!form.text.value.trim()) {
                    resultsElement.className = 'test-details show custom-test-results error';
                    resultsElement.innerHTML = '‚ùå Error: Please enter primary text for embedding generation';
                    notificationManager.warning('Missing Text', 'Please enter primary text for embedding generation');
                    return;
                }
                
                // Prepare form data
                const formData = new FormData();
                formData.append('text', form.text.value);

                if (form.batch_texts.value.trim()) {
                    formData.append('batch_texts', form.batch_texts.value);
                }

                // Send request (no file upload needed for embeddings)
                const response = await axios.post('/api/tests/embeddings/custom', formData, {
                    headers: {
                        'Content-Type': 'multipart/form-data'
                    }
                });
                
                const result = response.data;
                
                // Display results
                if (result.success) {
                    resultsElement.className = 'test-details show custom-test-results success';
                    resultsElement.innerHTML = formatEmbeddingsResult(result);
                } else {
                    resultsElement.className = 'test-details show custom-test-results error';
                    resultsElement.innerHTML = `‚ùå Embedding Generation Failed: ${result.message}\\n\\n${result.remediation || ''}`;
                }
                
            } catch (error) {
                resultsElement.className = 'test-details show custom-test-results error';
                const errorMessage = error.response?.data?.detail || error.message || 'Unknown error occurred';
                resultsElement.innerHTML = `‚ùå Error: ${errorMessage}`;
                handleApiError(error, 'Custom AI test');
            } finally {
                // Re-enable submit button
                submitButton.disabled = false;
                submitButton.innerHTML = 'Generate Embeddings';
            }
        }
        
        function formatEmbeddingsResult(result) {
            let html = `‚úÖ Embedding Generation Successful!\\n\\n`;
            html += `Model: ${result.model}\\n`;
            html += `Processing Time: ${result.response_time_ms}ms\\n`;
            html += `Embeddings Generated: ${result.embeddings_generated}\\n`;
            html += `Embedding Dimension: ${result.embedding_dimension}\\n`;
            
            if (result.total_tokens_used) {
                html += `Tokens Used: ${result.total_tokens_used}\\n`;
            }
            
            if (result.file_provided) {
                html += `File Content: Included`;
                if (result.file_type && result.file_type !== 'none') {
                    html += ` (${result.file_type.toUpperCase()})`;
                }
                html += `\\n`;
            }
            
            if (result.is_batch_processing) {
                html += `Batch Processing: Yes (${result.batch_size} texts)\\n`;
            }
            
            // Show embedding statistics
            if (result.embedding_stats && result.embedding_stats.length > 0) {
                html += `\\n--- Embedding Statistics ---\\n`;
                result.embedding_stats.forEach((stats, index) => {
                    html += `\\nText ${index + 1}: "${stats.input_text}"\\n`;
                    html += `- Dimension: ${stats.dimension}\\n`;
                    html += `- Range: ${stats.embedding_range.min} to ${stats.embedding_range.max}\\n`;
                    html += `- Mean: ${stats.embedding_range.mean}\\n`;
                    if (stats.vector_norm) {
                        html += `- Vector Norm: ${stats.vector_norm}\\n`;
                    }
                });
            }
            
            // Show similarity analysis
            if (result.similarities && result.similarities.length > 0) {
                html += `\\n--- Similarity Analysis ---\\n`;
                result.similarities.forEach(sim => {
                    html += `\\n"${sim.text1_preview}" vs "${sim.text2_preview}"\\n`;
                    html += `Similarity: ${sim.similarity} (${sim.similarity > 0.8 ? 'Very High' : sim.similarity > 0.6 ? 'High' : sim.similarity > 0.4 ? 'Medium' : sim.similarity > 0.2 ? 'Low' : 'Very Low'})\\n`;
                });
            }
            
            return html;
        }

        function formatS3Result(result) {
            const responseId = 's3-' + Date.now();
            let html = `<div class="test-result-enhanced s3-result">`;

            // Header with status
            let statusIcon, statusClass;
            if (result.status === 'passed') {
                statusIcon = '‚úÖ';
                statusClass = 'success';
            } else if (result.status === 'skipped') {
                statusIcon = '‚ö†Ô∏è';
                statusClass = 'warning';
            } else {
                statusIcon = '‚ùå';
                statusClass = 'error';
            }
            html += `<div class="result-header ${statusClass}">`;
            html += `<h4>${statusIcon} Amazon S3 Storage Test</h4>`;
            html += `<div class="test-meta">`;
            html += `<span class="duration">‚è±Ô∏è ${result.duration_seconds?.toFixed(2) || 'N/A'}s</span>`;
            html += `<span class="status">Status: ${result.status}</span>`;
            html += `</div>`;
            html += `</div>`;

            html += `<div class="result-message">`;
            html += `<p><strong>‚òÅÔ∏è Result:</strong> ${result.message}</p>`;
            html += `</div>`;

            // Storage summary from details
            if (result.details) {
                html += `<div class="storage-summary">`;
                html += `<h5>üì¶ S3 Configuration</h5>`;
                html += `<div class="summary-stats">`;
                if (result.details.region) {
                    html += `<span class="stat-item"><strong>üåç Region:</strong> ${result.details.region}</span>`;
                }
                if (result.details.bucket) {
                    html += `<span class="stat-item"><strong>ü™£ Bucket:</strong> ${result.details.bucket}</span>`;
                }
                if (result.details.endpoint) {
                    html += `<span class="stat-item"><strong>üîó Endpoint:</strong> ${result.details.endpoint}</span>`;
                }
                if (result.details.total_buckets !== undefined) {
                    html += `<span class="stat-item"><strong>üìö Total Buckets:</strong> ${result.details.total_buckets}</span>`;
                }
                html += `</div>`;
                html += `</div>`;
            }

            // Sub-tests
            if (result.sub_tests) {
                html += `<div class="sub-tests-section">`;
                html += `<h5>üîç Test Results:</h5>`;
                html += `<div class="sub-tests-grid">`;

                for (const [testName, testResult] of Object.entries(result.sub_tests)) {
                    const icon = testResult.success ? '‚úÖ' : testResult.skipped ? '‚ö†Ô∏è' : '‚ùå';
                    const itemClass = testResult.success ? 'sub-test-success' : 'sub-test-error';

                    html += `<div class="sub-test-item ${itemClass}">`;
                    html += `<div class="sub-test-header">${icon} <strong>${testName}</strong></div>`;
                    html += `<div class="sub-test-message">${testResult.message}</div>`;

                    if (testResult.details) {
                        html += `<div class="sub-test-details">`;
                        html += `<div class="stats-row">`;
                        Object.entries(testResult.details).forEach(([key, value]) => {
                            if (typeof value !== 'object') {
                                html += `<span class="stat-item"><strong>${key}:</strong> ${value}</span>`;
                            }
                        });
                        html += `</div>`;
                        html += `</div>`;
                    }

                    if (testResult.remediation) {
                        html += `<div class="remediation">üí° <em>${testResult.remediation}</em></div>`;
                    }

                    html += `</div>`;
                }

                html += `</div>`;
                html += `</div>`;
            }

            if (result.remediation) {
                html += `<div class="remediation-section">`;
                html += `<h5>üí° Remediation:</h5>`;
                html += `<div class="remediation-content">${result.remediation}</div>`;
                html += `</div>`;
            }

            html += `</div>`;
            return html;
        }

        function formatMinioResult(result) {
            const responseId = 'minio-' + Date.now();
            let html = `<div class="test-result-enhanced minio-result">`;

            // Header with status
            let statusIcon, statusClass;
            if (result.status === 'passed') {
                statusIcon = '‚úÖ';
                statusClass = 'success';
            } else if (result.status === 'skipped') {
                statusIcon = '‚ö†Ô∏è';
                statusClass = 'warning';
            } else {
                statusIcon = '‚ùå';
                statusClass = 'error';
            }
            html += `<div class="result-header ${statusClass}">`;
            html += `<h4>${statusIcon} MinIO Storage Test</h4>`;
            html += `<div class="test-meta">`;
            html += `<span class="duration">‚è±Ô∏è ${result.duration_seconds?.toFixed(2) || 'N/A'}s</span>`;
            html += `<span class="status">Status: ${result.status}</span>`;
            html += `</div>`;
            html += `</div>`;

            html += `<div class="result-message">`;
            html += `<p><strong>üóÑÔ∏è Result:</strong> ${result.message}</p>`;
            html += `</div>`;

            // Storage summary from details
            if (result.details) {
                html += `<div class="storage-summary">`;
                html += `<h5>üì¶ MinIO Configuration</h5>`;
                html += `<div class="summary-stats">`;
                if (result.details.endpoint) {
                    html += `<span class="stat-item"><strong>üîó Endpoint:</strong> ${result.details.endpoint}</span>`;
                }
                if (result.details.bucket) {
                    html += `<span class="stat-item"><strong>ü™£ Bucket:</strong> ${result.details.bucket}</span>`;
                }
                if (result.details.secure !== undefined) {
                    html += `<span class="stat-item"><strong>üîí Secure:</strong> ${result.details.secure ? 'Yes' : 'No'}</span>`;
                }
                if (result.details.total_buckets !== undefined) {
                    html += `<span class="stat-item"><strong>üìö Total Buckets:</strong> ${result.details.total_buckets}</span>`;
                }
                html += `</div>`;
                html += `</div>`;
            }

            // Sub-tests
            if (result.sub_tests) {
                html += `<div class="sub-tests-section">`;
                html += `<h5>üîç Test Results:</h5>`;
                html += `<div class="sub-tests-grid">`;

                for (const [testName, testResult] of Object.entries(result.sub_tests)) {
                    const icon = testResult.success ? '‚úÖ' : testResult.skipped ? '‚ö†Ô∏è' : '‚ùå';
                    const itemClass = testResult.success ? 'sub-test-success' : 'sub-test-error';

                    html += `<div class="sub-test-item ${itemClass}">`;
                    html += `<div class="sub-test-header">${icon} <strong>${testName}</strong></div>`;
                    html += `<div class="sub-test-message">${testResult.message}</div>`;

                    if (testResult.details) {
                        html += `<div class="sub-test-details">`;
                        html += `<div class="stats-row">`;
                        Object.entries(testResult.details).forEach(([key, value]) => {
                            if (typeof value !== 'object') {
                                html += `<span class="stat-item"><strong>${key}:</strong> ${value}</span>`;
                            }
                        });
                        html += `</div>`;
                        html += `</div>`;
                    }

                    if (testResult.remediation) {
                        html += `<div class="remediation">üí° <em>${testResult.remediation}</em></div>`;
                    }

                    html += `</div>`;
                }

                html += `</div>`;
                html += `</div>`;
            }

            if (result.remediation) {
                html += `<div class="remediation-section">`;
                html += `<h5>üí° Remediation:</h5>`;
                html += `<div class="remediation-content">${result.remediation}</div>`;
                html += `</div>`;
            }

            html += `</div>`;
            return html;
        }

        function formatOpenAIResult(result) {
            const responseId = 'openai-' + Date.now();
            let html = `<div class="test-result-enhanced openai-result">`;

            // Header with status
            let statusIcon, statusClass;
            if (result.status === 'passed') {
                statusIcon = '‚úÖ';
                statusClass = 'success';
            } else if (result.status === 'skipped') {
                statusIcon = '‚ö†Ô∏è';
                statusClass = 'warning';
            } else {
                statusIcon = '‚ùå';
                statusClass = 'error';
            }
            html += `<div class="result-header ${statusClass}">`;
            html += `<h4>${statusIcon} OpenAI/AI Models Test</h4>`;
            html += `<div class="test-meta">`;
            html += `<span class="duration">‚è±Ô∏è ${result.duration_seconds?.toFixed(2) || 'N/A'}s</span>`;
            html += `<span class="status">Status: ${result.status}</span>`;
            html += `</div>`;
            html += `</div>`;

            html += `<div class="result-message">`;
            html += `<p><strong>ü§ñ Result:</strong> ${result.message}</p>`;
            html += `</div>`;

            // AI Configuration summary
            if (result.details) {
                html += `<div class="database-summary">`;
                html += `<h5>üß† AI Configuration</h5>`;
                html += `<div class="summary-stats">`;
                if (result.details.provider) {
                    html += `<span class="stat-item"><strong>üè¢ Provider:</strong> ${result.details.provider}</span>`;
                }
                if (result.details.endpoint) {
                    html += `<span class="stat-item"><strong>üîó Endpoint:</strong> ${result.details.endpoint}</span>`;
                }
                if (result.details.deployment || result.details.model) {
                    const modelName = result.details.deployment || result.details.model;
                    html += `<span class="stat-item"><strong>ü§ñ Model:</strong> ${modelName}</span>`;
                }
                if (result.details.api_version) {
                    html += `<span class="stat-item"><strong>üìã API Version:</strong> ${result.details.api_version}</span>`;
                }
                html += `</div>`;
                html += `</div>`;
            }

            // Sub-tests
            if (result.sub_tests) {
                html += `<div class="sub-tests-section">`;
                html += `<h5>üîç Model Tests:</h5>`;
                html += `<div class="sub-tests-grid">`;

                for (const [testName, testResult] of Object.entries(result.sub_tests)) {
                    const icon = testResult.success ? '‚úÖ' : testResult.skipped ? '‚ö†Ô∏è' : '‚ùå';
                    const itemClass = testResult.success ? 'sub-test-success' : 'sub-test-error';

                    html += `<div class="sub-test-item ${itemClass}">`;
                    html += `<div class="sub-test-header">${icon} <strong>${testName}</strong></div>`;
                    html += `<div class="sub-test-message">${testResult.message}</div>`;

                    // Show models list for API Connection test
                    if (testName === 'API Connection' && testResult.models && testResult.models.length > 0) {
                        html += `<div class="sub-test-details">`;
                        html += `<span class="stat-label">üìã Available Models (${testResult.models.length}):</span><br/>`;
                        html += `<div class="models-list">`;
                        testResult.models.forEach(model => {
                            html += `<span class="model-badge">${model}</span>`;
                        });
                        html += `</div>`;
                        html += `</div>`;
                    }

                    // Show prompt and response for completion tests
                    if (testName === 'Text Completion' && testResult.success) {
                        html += `<div class="sub-test-details">`;

                        if (testResult.model) {
                            html += `<div class="stats-row">`;
                            html += `<span class="stat-item"><strong>ü§ñ Model:</strong> ${testResult.model}</span>`;
                            if (testResult.validation_passed !== undefined) {
                                const validIcon = testResult.validation_passed ? '‚úÖ' : '‚ùå';
                                html += `<span class="stat-item"><strong>‚úì Validation:</strong> ${validIcon} ${testResult.validation_passed ? 'Passed' : 'Failed'}</span>`;
                            }
                            html += `</div>`;
                        }

                        if (testResult.response_text) {
                            html += `<div class="prompt-section">`;
                            html += `<span class="stat-label">üí¨ Test:</span>`;
                            html += `<div class="prompt-text">What is 2+2? Answer with just the number.</div>`;
                            html += `</div>`;
                            const displayResponse = testResult.response_text.length > 200 ? testResult.response_text.substring(0, 200) + '...' : testResult.response_text;
                            html += `<div class="response-section">`;
                            html += `<span class="stat-label">üí° Response:</span>`;
                            html += `<div class="response-text">"${displayResponse}"</div>`;
                            html += `</div>`;
                        }

                        html += `<div class="stats-row">`;
                        if (testResult.response_time_ms) {
                            html += `<span class="stat-item"><strong>‚è±Ô∏è Time:</strong> ${testResult.response_time_ms.toFixed(0)}ms</span>`;
                        }
                        if (testResult.tokens_used) {
                            const tokens = testResult.tokens_used;
                            html += `<span class="stat-item"><strong>üéØ Tokens:</strong> ${tokens.total_tokens || 'N/A'} (${tokens.prompt_tokens || 0}p + ${tokens.completion_tokens || 0}c)</span>`;
                        }
                        html += `</div>`;
                        html += `</div>`;
                    }

                    // Show custom prompt details
                    if (testName === 'Custom Prompt' && testResult.success) {
                        html += `<div class="sub-test-details">`;

                        if (testResult.model) {
                            html += `<div class="stats-row">`;
                            html += `<span class="stat-item"><strong>ü§ñ Model:</strong> ${testResult.model}</span>`;
                            html += `</div>`;
                        }

                        if (testResult.prompt) {
                            html += `<div class="prompt-section">`;
                            html += `<span class="stat-label">üí¨ Prompt:</span>`;
                            const promptDisplay = testResult.prompt.length > 150 ? testResult.prompt.substring(0, 150) + '...' : testResult.prompt;
                            html += `<div class="prompt-text">"${promptDisplay}"</div>`;
                            html += `</div>`;
                        }

                        if (testResult.response_text) {
                            const displayResponse = testResult.response_text.length > 200 ? testResult.response_text.substring(0, 200) + '...' : testResult.response_text;
                            html += `<div class="response-section">`;
                            html += `<span class="stat-label">üí° Response:</span>`;
                            html += `<div class="response-text">"${displayResponse}"</div>`;
                            html += `</div>`;
                        }

                        html += `<div class="stats-row">`;
                        if (testResult.response_time_ms) {
                            html += `<span class="stat-item"><strong>‚è±Ô∏è Time:</strong> ${testResult.response_time_ms.toFixed(0)}ms</span>`;
                        }
                        if (testResult.tokens_used) {
                            const tokens = testResult.tokens_used;
                            html += `<span class="stat-item"><strong>üéØ Tokens:</strong> ${tokens.total_tokens || 'N/A'}</span>`;
                        }
                        html += `</div>`;
                        html += `</div>`;
                    }

                    // Show embedding details
                    if (testName === 'Text Embedding' && testResult.success) {
                        html += `<div class="sub-test-details">`;

                        if (testResult.model) {
                            html += `<div class="stats-row">`;
                            html += `<span class="stat-item"><strong>ü§ñ Model:</strong> ${testResult.model}</span>`;
                            html += `</div>`;
                        }

                        if (testResult.input_text) {
                            html += `<div class="prompt-section">`;
                            html += `<span class="stat-label">üìù Input:</span>`;
                            const inputDisplay = testResult.input_text.length > 100 ? testResult.input_text.substring(0, 100) + '...' : testResult.input_text;
                            html += `<div class="prompt-text">"${inputDisplay}"</div>`;
                            html += `</div>`;
                        }

                        html += `<div class="stats-row">`;
                        if (testResult.embedding_dimensions) {
                            html += `<span class="stat-item"><strong>üìê Dimensions:</strong> ${testResult.embedding_dimensions}</span>`;
                        }
                        if (testResult.response_time_ms) {
                            html += `<span class="stat-item"><strong>‚è±Ô∏è Time:</strong> ${testResult.response_time_ms.toFixed(0)}ms</span>`;
                        }
                        if (testResult.tokens_used) {
                            html += `<span class="stat-item"><strong>üéØ Tokens:</strong> ${testResult.tokens_used}</span>`;
                        }
                        html += `</div>`;

                        if (testResult.sample_values && testResult.sample_values.length > 0) {
                            html += `<div class="stats-row">`;
                            html += `<span class="stat-label">üìä Sample Values:</span>`;
                            const samples = testResult.sample_values.map(v => v.toFixed(6)).join(', ');
                            html += `<span class="stat-value">[${samples}...]</span>`;
                            html += `</div>`;
                        }

                        html += `</div>`;
                    }

                    if (testResult.remediation) {
                        html += `<div class="remediation">üí° <em>${testResult.remediation}</em></div>`;
                    }

                    html += `</div>`;
                }

                html += `</div>`;
                html += `</div>`;
            }

            if (result.remediation) {
                html += `<div class="remediation-section">`;
                html += `<h5>üí° Remediation:</h5>`;
                html += `<div class="remediation-content">${result.remediation}</div>`;
                html += `</div>`;
            }

            html += `</div>`;
            return html;
        }
    </script>
</body>
</html>